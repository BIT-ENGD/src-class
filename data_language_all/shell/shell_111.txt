#!/bin/bash
#
# Streisand yamllint wrapper
#
# This test script finds all of the *.yml files in the project tree and
# runs yamllint against them. Ignore any `venv` directory.
#

# Fail on errors
set -e

# Ensure yamllint is present
if ! command -v yamllint > /dev/null 2>&1; then
    echo "The 'yamllint' command was not found in your PATH."
    echo "Please run 'pip install yamllint' to install."
    exit 1
fi

# Determine the absolute path of this script file's directory
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd -P)"
# The Streisand project directory is one up from this script's directory, tests/
PROJECT_DIR="$SCRIPT_DIR/.."

# Streisand specifies a custom yamllint config to adjust what rules are applied
YAMLLINT_ARGS=(-c "$SCRIPT_DIR/yamllint-config.yml")

pushd "$PROJECT_DIR"
  # Run yamllint against all of the `.yml` files in the Streisand
  # project directory.
  #
  # NOTE(@cpu): While tempting to -exec shellcheck directly from find this will
  # eat-up any non-zero exit codes :-( Instead we find the files first and then
  # xargs yamllint on the found files.
  find . -path "./venv" -prune -or -name '*.yml' -print0 | xargs -0 -n1 yamllint "${YAMLLINT_ARGS[@]}"
popd
#!/bin/bash -xe
#
# NOTE: This test script relies on the -e argument to bash in the shebang above.
#
# Streisand Shadowsocks Client Test
#   - Confirms the gateway mirror for the Linux Shadowsocks client works
#   - Confirms the gateway Shadowsocks QR has correct information (password, cipher, etc)
#   - Confirms that the Linux shadowsocks client can connect & route a HTTP request
#

# Read the Shadowsocks QR code attributes into vars
shadowsocksCipher=$(shadowsocks-qr-decode --cipher "{{ shadowsocks_qr_file }}" 2>/dev/null)
shadowsocksPassword=$(shadowsocks-qr-decode --password "{{ shadowsocks_qr_file }}" 2>/dev/null)
shadowsocksServer=$(shadowsocks-qr-decode --server "{{ shadowsocks_qr_file }}" 2>/dev/null)
shadowsocksPort=$(shadowsocks-qr-decode --port "{{ shadowsocks_qr_file }}" 2>/dev/null)

# Read the gateway password into a var
gatewayPassword=$(cat "{{ gateway_password_file }}")

# Connect the Shadowsocks client to the server
{{ shadowsocks_client }} -c "$shadowsocksServer:$shadowsocksPort" -password "$shadowsocksPassword" -socks localhost:{{ shadowsocks_local_port }} -verbose -cipher "$shadowsocksCipher" &
CLIENT_PID=$!

function cleanup {
  # Kill the backgrounded Shadowsocks client
  echo "Killing PID $CLIENT_PID"
  kill $CLIENT_PID
  echo "Waiting for clean up to finish..."
  wait $CLIENT_PID
}
trap cleanup EXIT

# Sleep to give the Shadowsocks client a chance to start
sleep 2

# Check that the gateway website can be loaded through the Shadowsocks proxy
curl --socks5 localhost:{{ shadowsocks_local_port }} --insecure -I -u "{{ gateway_test_user }}:$gatewayPassword" {{ gateway_test_url }} | grep "200 OK"

# Check that an external site can be loaded through the Shadowsocks proxy
curl --socks5 localhost:{{ shadowsocks_local_port }} --insecure -I -u "{{ gateway_test_user }}:$gatewayPassword" {{ external_test_url }} | grep "200 OK"
#!/bin/bash -xe
#
# NOTE: This test script relies on the -e argument to bash in the shebang above.
#
# Streisand Shadowsocks Client Test
#   - Confirms the gateway mirror for the Linux Shadowsocks client works
#   - Confirms the gateway Shadowsocks QR has correct information (password, cipher, etc)
#   - Confirms that the Linux shadowsocks client can connect & route a HTTP request
#

# Read the Shadowsocks QR code attributes into vars
shadowsocksCipher=$(shadowsocks-qr-decode --cipher "{{ shadowsocks_qr_file }}" 2>/dev/null)
shadowsocksPassword=$(shadowsocks-qr-decode --password "{{ shadowsocks_qr_file }}" 2>/dev/null)
shadowsocksServer=$(shadowsocks-qr-decode --server "{{ shadowsocks_qr_file }}" 2>/dev/null)
shadowsocksPort=$(shadowsocks-qr-decode --port "{{ shadowsocks_qr_file }}" 2>/dev/null)

# Read the gateway password into a var
gatewayPassword=$(cat "{{ gateway_password_file }}")

# Connect the Shadowsocks client to the server
{{ shadowsocks_client }} -c "$shadowsocksServer:$shadowsocksPort" -password "$shadowsocksPassword" -socks localhost:{{ shadowsocks_local_port }} -verbose -cipher "$shadowsocksCipher" &
CLIENT_PID=$!

function cleanup {
  # Kill the backgrounded Shadowsocks client
  echo "Killing PID $CLIENT_PID"
  kill $CLIENT_PID
  echo "Waiting for clean up to finish..."
  wait $CLIENT_PID
}
trap cleanup EXIT

# Sleep to give the Shadowsocks client a chance to start
sleep 2

# Check that the gateway website can be loaded through the Shadowsocks proxy
curl --socks5 localhost:{{ shadowsocks_local_port }} --insecure -I -u "{{ gateway_test_user }}:$gatewayPassword" {{ gateway_test_url }} | grep "200 OK"

# Check that an external site can be loaded through the Shadowsocks proxy
curl --socks5 localhost:{{ shadowsocks_local_port }} --insecure -I -u "{{ gateway_test_user }}:$gatewayPassword" {{ external_test_url }} | grep "200 OK"
