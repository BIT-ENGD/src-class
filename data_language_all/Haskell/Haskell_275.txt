module Luna.Package.Configuration.GlobalSpec where

import Prologue

import qualified Luna.Package.Configuration.Global as Global

import Data.ByteString     ( ByteString )
import Luna.YamlUtils.Test ( shouldDecodeAs
                           , shouldNotDecode
                           , shouldGenerate )
import Test.Hspec          ( Spec, describe, it)

allFieldsUsed :: ByteString
allFieldsUsed = [qqStr|
user:
  email: bob@name.com
  name: Bob
license:
  default-license: mit
  generate-license: true
compiler:
  version: '1.3.5'
  options:
  - Foo
  - Bar
  - Baz
|]

allFieldsUsedResult :: Global.Config
allFieldsUsedResult = Global.Config
    (Global.UserConfig "Bob" "bob@name.com")
    (Just (Global.LicenseConfig (Just True) (Just "mit")))
    (Just (Global.CompilerConfig (Just "1.3.5") (Just ["Foo", "Bar", "Baz"])))

missingOptionalFields :: ByteString
missingOptionalFields = [qqStr|
user:
  email: bob@name.com
  name: Bob
|]

missingOptionalFieldsResult :: Global.Config
missingOptionalFieldsResult =
    Global.Config (Global.UserConfig "Bob" "bob@name.com") Nothing Nothing

missingRequiredField :: ByteString
missingRequiredField = [qqStr|
user:
  name  : Bob
|]

invalidKeys :: ByteString
invalidKeys = [qqStr|
user:
  email : bob@name.com
  name  : Bob
  em    : Foo
|]

spec :: Spec
spec = do
    describe "Parses from yaml" $ do
        it "Succeeds with all fields used"
            $ allFieldsUsed `shouldDecodeAs` (Just allFieldsUsedResult)
        it "Succeeds with non-required fields omitted"
            $ missingOptionalFields `shouldDecodeAs`
                (Just missingOptionalFieldsResult)

    describe "Does not parse malformed yaml" $
        it "Fails on missing required keys"
            $ shouldNotDecode @Global.Config missingRequiredField

    describe "Generates correct Yaml from the internal representation" $ do
        it "when optional fields are omitted"
            $ allFieldsUsedResult `shouldGenerate` allFieldsUsed
        it "when all fields are present"
            $ missingOptionalFieldsResult `shouldGenerate` missingOptionalFields

module Luna.Package.Configuration.LocalSpec where

import Prologue

import qualified Luna.Package.Configuration.License as License
import qualified Luna.Package.Configuration.Local   as Local

import Data.ByteString      ( ByteString )
import Luna.Package.Version ( Version(Version) )
import Luna.YamlUtils.Test  ( shouldDecodeAs
                            , shouldNotDecode
                            , shouldGenerate )
import Test.Hspec           ( Spec, describe, it)

allFieldsUsed :: ByteString
allFieldsUsed = [qqStr|
project-name: Foo
external-targets:
- stage: before-compilation
  tool: gcc
  name: Dep
  output: ../lib
  options:
  - -lfoo
project-version:
  minor: 0
  major: 0
  patch: 1
luna-options:
- Foo
- Bar
- Baz
build-type: library
maintainer: joe@email.com
synopsis: This is a test package.
author: Joe Bloggs
license:
  tag: unknown
  contents: My Custom License
description: This is my package description.
|]

allFieldsUsedResult :: Local.Config
allFieldsUsedResult = Local.Config
    "Joe Bloggs"
    "joe@email.com"
    "Foo"
    (Version 0 0 1 Nothing)
    (License.Unknown "My Custom License")
    Local.Library
    "This is a test package."
    "This is my package description."
    (Just ["Foo", "Bar", "Baz"])
    (Just [Local.Target "Dep" "gcc" "../lib" ["-lfoo"] Local.BeforeCompilation])

optionalFieldsOmitted :: ByteString
optionalFieldsOmitted = [qqStr|
project-name: Foo
project-version:
  minor: 0
  major: 0
  patch: 1
build-type: library
maintainer: joe@email.com
synopsis: This is a test package.
author: Joe Bloggs
license:
  tag: mit
description: This is my package description.
|]

optionalFieldsOmittedResult :: Local.Config
optionalFieldsOmittedResult = Local.Config
    "Joe Bloggs"
    "joe@email.com"
    "Foo"
    (Version 0 0 1 Nothing)
    (License.MIT)
    Local.Library
    "This is a test package."
    "This is my package description."
    Nothing
    Nothing

invalidYaml :: ByteString
invalidYaml = [qqStr|
project-version:
  minor: 0
  major: 0
  patch: 1
|]

spec :: Spec
spec = do
    describe "Parses from Yaml" $ do
        it "Succeeds with all fields used"
            $ allFieldsUsed `shouldDecodeAs` (Just allFieldsUsedResult)
        it "Succeeds with optional fields omitted"
            $ optionalFieldsOmitted `shouldDecodeAs`
                (Just optionalFieldsOmittedResult)

    describe "Does not parse malformed Yaml" $
        it "Fails on missing required keys"
            $ shouldNotDecode @Local.Config invalidYaml

    describe "Generates correct yaml from the internal representation" $ do
        it "when optional fields are omitted"
            $ optionalFieldsOmittedResult `shouldGenerate` optionalFieldsOmitted
        it "when all fields are present"
            $ allFieldsUsedResult `shouldGenerate` allFieldsUsed

