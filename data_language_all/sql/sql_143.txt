/* Nodes which are a complete graph 3 */
/*
    2 - 3
    | /
    1
 */
use brooklyn_core_graph;
drop table if exists provider_three_complete_graph;
create table provider_three_complete_graph(id integer not null AUTO_INCREMENT,
  npi1 char(10), npi2 char(10), npi3 char(10),
  id1 integer, id2 integer, id3 integer,
  weight12 double, weight23 double,  weight31 double,min_weight double,
  set_indicator varchar(100), primary key(id));


/* This query is taking over five days to run */

insert into provider_three_complete_graph
  (npi1, npi2, npi3, id1, id2, id3, weight12, weight23, weight31, min_weight)
select
  pug1.npi1 as npi1,pug2.npi1 as npi2,pug3.npi2 as npi3,
  pug1.id as id1,pug2.id as id2,pug3.id as id3,
  pug1.mean_weight, pug2.mean_weight, pug3.mean_weight,
  case
    when pug1.mean_weight <= pug2.mean_weight and pug1.mean_weight <= pug3.mean_weight
      then pug1.mean_weight
    when pug2.mean_weight <= pug1.mean_weight and pug2.mean_weight <= pug3.mean_weight
      then pug2.mean_weight
    when pug3.mean_weight <= pug2.mean_weight and pug3.mean_weight <= pug1.mean_weight
      then pug3.mean_weight
  end as min_weight
  from provider_undirected_graph pug1
  join provider_undirected_graph pug2
    on pug1.npi2 = pug2.npi1
  join provider_undirected_graph pug3
  on pug3.npi2 = pug2.npi2 and pug3.npi1 = pug1.npi1
  ;

create table provider_npis_in_triangles (npi char(10) not null, primary key(npi));

insert into provider_npis_in_triangles (npi)
  select distinct npi1 from provider_three_complete_graph
    union
  select distinct npi2 from provider_three_complete_graph
    union
  select distinct npi3 from provider_three_complete_graph;

/*

select ptcg.*, nspt1.provider_name, nspt1.taxonomy_name, nspt2.provider_name, nspt2.taxonomy_name, nspt3.provider_name, nspt3.taxonomy_name
from provider_three_complete_graph ptcg join
  referral.npi_summary_primary_taxonomy nspt1
    on nspt1.npi = ptcg.npi1
  join referral.npi_summary_primary_taxonomy nspt2
    on nspt2.npi = ptcg.npi2
  join referral.npi_summary_primary_taxonomy nspt3
    on nspt3.npi = ptcg.npi3
  order by min_weight desc;

*/

create index idx_p3cg_npi1 on provider_three_complete_graph(npi1);
create index idx_p3cg_npi2 on provider_three_complete_graph(npi2);
create index idx_p3cg_npi3 on provider_three_complete_graph(npi3);

/* Nodes which are a complete graph 4 */
/*
    2 - 3
    | X |
    1 - 4
*/

drop table if exists provider_four_complete_graph;
create table provider_four_complete_graph(id integer not null auto_increment,
  npi1 char(10), npi2 char(10), npi3 char(10), npi4 char(10),
  id1 integer, id2 integer, id3 integer, id4 integer,
  set_indicator varchar(100), primary key(id));


/*
insert into provider_four_complete_graph
  (npi1, npi2, npi3, npi4, id1, id2, id3, id4, min_weight)
    select ptcg1.npi1, ptcg1.npi2, ptcg1.npi3, ptcg2.npi3, ptcg1.id1, ptcg1.id2, ptcg1.id3, ptcg2.id3,
      case when ptcg1.min_weight < ptcg2.min_weight then ptcg1.min_weight else ptcg2.min_weight end as min_weight
     from provider_three_complete_graph ptcg1
      join provider_three_complete_graph ptcg2
    on ptcg1.npi1 = ptcg2.npi1 and
     ptcg1.npi3 = ptcg2.npi2;



insert into provider_npis_in_four_complete (npi)
  select distinct npi1 from provider_three_complete_graph
    union
  select distinct npi2 from provider_three_complete_graph
    union
  select distinct npi3 from provider_three_complete_graph
    union
  select distinct npi4 from provider_three_complete_graph;

*/-- MySQL dump 10.11
--
-- Host: localhost    Database: realmd
-- ------------------------------------------------------
-- Server version    5.0.45-Debian_1ubuntu3.1-log

/*!40101 SET @OLD_CHARACTER_SET_CLIENT=@@CHARACTER_SET_CLIENT */;
/*!40101 SET @OLD_CHARACTER_SET_RESULTS=@@CHARACTER_SET_RESULTS */;
/*!40101 SET @OLD_COLLATION_CONNECTION=@@COLLATION_CONNECTION */;
/*!40101 SET NAMES utf8 */;
/*!40103 SET @OLD_TIME_ZONE=@@TIME_ZONE */;
/*!40103 SET TIME_ZONE='+00:00' */;
/*!40014 SET @OLD_UNIQUE_CHECKS=@@UNIQUE_CHECKS, UNIQUE_CHECKS=0 */;
/*!40014 SET @OLD_FOREIGN_KEY_CHECKS=@@FOREIGN_KEY_CHECKS, FOREIGN_KEY_CHECKS=0 */;
/*!40101 SET @OLD_SQL_MODE=@@SQL_MODE, SQL_MODE='NO_AUTO_VALUE_ON_ZERO' */;
/*!40111 SET @OLD_SQL_NOTES=@@SQL_NOTES, SQL_NOTES=0 */;

--
-- Table structure for table `realmd_db_version`
--

DROP TABLE IF EXISTS `realmd_db_version`;
CREATE TABLE `realmd_db_version` (
  `required_z2426_01_realmd_relations` bit(1) default NULL
) ENGINE=MyISAM DEFAULT CHARSET=utf8 ROW_FORMAT=FIXED COMMENT='Last applied sql update to DB';

--
-- Dumping data for table `realmd_db_version`
--

LOCK TABLES `realmd_db_version` WRITE;
/*!40000 ALTER TABLE `realmd_db_version` DISABLE KEYS */;
INSERT INTO `realmd_db_version` VALUES
(NULL);
/*!40000 ALTER TABLE `realmd_db_version` ENABLE KEYS */;
UNLOCK TABLES;

--
-- Table structure for table `account`
--

DROP TABLE IF EXISTS `account`;
CREATE TABLE `account` (
  `id` INT( 11 ) UNSIGNED NOT NULL AUTO_INCREMENT COMMENT  'Account identifier',
  `username`      varchar(32) NOT NULL default '',
  `sha_pass_hash` varchar(40) NOT NULL default '',
  `gmlevel` tinyint(3) unsigned NOT NULL default '0',
  `sessionkey` longtext,
  `v` longtext,
  `s` longtext,
  `email` text,
  `joindate` timestamp NOT NULL default CURRENT_TIMESTAMP,
  `last_ip` varchar(30) NOT NULL default '0.0.0.0',
  `failed_logins` int(11) unsigned NOT NULL default '0',
  `locked` tinyint(3) unsigned NOT NULL default '0',
  `last_login` timestamp NOT NULL default '0000-00-00 00:00:00',
  `active_realm_id` int(11) unsigned NOT NULL default '0',
  `expansion` tinyint(3) unsigned NOT NULL default '0',
  `mutetime` bigint(40) unsigned NOT NULL default '0',
  `locale` tinyint(3) unsigned NOT NULL default '0',
  PRIMARY KEY  (`id`),
  UNIQUE KEY `idx_username` (`username`),
  KEY `idx_gmlevel` (`gmlevel`)
) ENGINE=MyISAM AUTO_INCREMENT=5 DEFAULT CHARSET=utf8 COLLATE=utf8_general_ci ROW_FORMAT=DYNAMIC COMMENT='Account System';

--
-- Dumping data for table `account`
--

LOCK TABLES `account` WRITE;
/*!40000 ALTER TABLE `account` DISABLE KEYS */;
INSERT INTO `account` VALUES
(1,'ADMINISTRATOR','a34b29541b87b7e4823683ce6c7bf6ae68beaaac',3,'','0','0','','2006-04-25 10:18:56','127.0.0.1',0,0,'0000-00-00 00:00:00',0,0,0,0),
(2,'GAMEMASTER','7841e21831d7c6bc0b57fbe7151eb82bd65ea1f9',2,'','0','0','','2006-04-25 10:18:56','127.0.0.1',0,0,'0000-00-00 00:00:00',0,0,0,0),
(3,'MODERATOR','a7f5fbff0b4eec2d6b6e78e38e8312e64d700008',1,'','0','0','','2006-04-25 10:19:35','127.0.0.1',0,0,'0000-00-00 00:00:00',0,0,0,0),
(4,'PLAYER','3ce8a96d17c5ae88a30681024e86279f1a38c041',0,'','0','0','','2006-04-25 10:19:35','127.0.0.1',0,0,'0000-00-00 00:00:00',0,0,0,0);
/*!40000 ALTER TABLE `account` ENABLE KEYS */;
UNLOCK TABLES;

--
-- Table structure for table `account_banned`
--

DROP TABLE IF EXISTS `account_banned`;
CREATE TABLE `account_banned` (
  `id` INT( 11 ) UNSIGNED NOT NULL COMMENT  'Account identifier',
  `bandate` bigint(40) NOT NULL default '0',
  `unbandate` bigint(40) NOT NULL default '0',
  `bannedby` varchar(50) NOT NULL,
  `banreason` varchar(255) NOT NULL,
  `active` tinyint(4) NOT NULL default '1',
  PRIMARY KEY  (`id`,`bandate`)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 ROW_FORMAT=DYNAMIC COMMENT='Ban List';

--
-- Dumping data for table `account_banned`
--

LOCK TABLES `account_banned` WRITE;
/*!40000 ALTER TABLE `account_banned` DISABLE KEYS */;
/*!40000 ALTER TABLE `account_banned` ENABLE KEYS */;
UNLOCK TABLES;

--
-- Table structure for table `ip_banned`
--

DROP TABLE IF EXISTS `ip_banned`;
CREATE TABLE `ip_banned` (
  `ip` varchar(32) NOT NULL default '0.0.0.0',
  `bandate` bigint(40) NOT NULL,
  `unbandate` bigint(40) NOT NULL,
  `bannedby` varchar(50) NOT NULL default '[Console]',
  `banreason` varchar(255) NOT NULL default 'no reason',
  PRIMARY KEY  (`ip`,`bandate`)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 ROW_FORMAT=DYNAMIC COMMENT='Banned IPs';

--
-- Dumping data for table `ip_banned`
--

LOCK TABLES `ip_banned` WRITE;
/*!40000 ALTER TABLE `ip_banned` DISABLE KEYS */;
/*!40000 ALTER TABLE `ip_banned` ENABLE KEYS */;
UNLOCK TABLES;

--
-- Table structure for table `realmcharacters`
--

DROP TABLE IF EXISTS `realmcharacters`;
CREATE TABLE `realmcharacters` (
  `realmid` INT( 11 ) UNSIGNED NOT NULL COMMENT  'Account identifier',
  `acctid` INT( 11 ) UNSIGNED NOT NULL COMMENT  'Realm identifier',
  `numchars` tinyint(3) unsigned NOT NULL default '0',
  PRIMARY KEY  (`realmid`,`acctid`),
  KEY (acctid)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 ROW_FORMAT=DYNAMIC COMMENT='Realm Character Tracker';

--
-- Dumping data for table `realmcharacters`
--

LOCK TABLES `realmcharacters` WRITE;
/*!40000 ALTER TABLE `realmcharacters` DISABLE KEYS */;
/*!40000 ALTER TABLE `realmcharacters` ENABLE KEYS */;
UNLOCK TABLES;

--
-- Table structure for table `realmlist`
--

DROP TABLE IF EXISTS `realmlist`;
CREATE TABLE `realmlist` (
  `id` INT( 11 ) UNSIGNED NOT NULL AUTO_INCREMENT COMMENT  'Realm identifier',
  `name` varchar(32) NOT NULL default '',
  `address` varchar(32) NOT NULL default '127.0.0.1',
  `port` int(11) NOT NULL default '8085',
  `icon` tinyint(3) unsigned NOT NULL default '0',
  `realmflags` tinyint(3) unsigned NOT NULL default '2' COMMENT 'Supported masks: 0x1 (invalid, not show in realm list), 0x2 (offline, set by mangosd), 0x4 (show version and build), 0x20 (new players), 0x40 (recommended)',
  `timezone` tinyint(3) unsigned NOT NULL default '0',
  `allowedSecurityLevel` tinyint(3) unsigned NOT NULL default '0',
  `population` float unsigned NOT NULL default '0',
  `realmbuilds` varchar(64) NOT NULL default '',
  PRIMARY KEY  (`id`),
  UNIQUE KEY `idx_name` (`name`)
) ENGINE=MyISAM AUTO_INCREMENT=2 DEFAULT CHARSET=utf8 ROW_FORMAT=DYNAMIC COMMENT='Realm System';

--
-- Dumping data for table `realmlist`
--

LOCK TABLES `realmlist` WRITE;
/*!40000 ALTER TABLE `realmlist` DISABLE KEYS */;
INSERT INTO `realmlist` VALUES
(1,'MaNGOS','127.0.0.1',8085,0,2,0,0,0,'');
/*!40000 ALTER TABLE `realmlist` ENABLE KEYS */;
UNLOCK TABLES;

--
-- Table structure for table `uptime`
--

DROP TABLE IF EXISTS `uptime`;
CREATE TABLE `uptime` (
  `realmid` INT( 11 ) UNSIGNED NOT NULL COMMENT  'Realm identifier',
  `starttime` bigint(20) unsigned NOT NULL default '0',
  `startstring` varchar(64) NOT NULL default '',
  `uptime` bigint(20) unsigned NOT NULL default '0',
  `maxplayers` smallint(5) unsigned NOT NULL default '0',
  PRIMARY KEY  (`realmid`,`starttime`)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 ROW_FORMAT=DYNAMIC COMMENT='Uptime system';

--
-- Dumping data for table `uptime`
--

LOCK TABLES `uptime` WRITE;
/*!40000 ALTER TABLE `uptime` DISABLE KEYS */;
/*!40000 ALTER TABLE `uptime` ENABLE KEYS */;
UNLOCK TABLES;
/*!40103 SET TIME_ZONE=@OLD_TIME_ZONE */;

/*!40101 SET SQL_MODE=@OLD_SQL_MODE */;
/*!40014 SET FOREIGN_KEY_CHECKS=@OLD_FOREIGN_KEY_CHECKS */;
/*!40014 SET UNIQUE_CHECKS=@OLD_UNIQUE_CHECKS */;
/*!40101 SET CHARACTER_SET_CLIENT=@OLD_CHARACTER_SET_CLIENT */;
/*!40101 SET CHARACTER_SET_RESULTS=@OLD_CHARACTER_SET_RESULTS */;
/*!40101 SET COLLATION_CONNECTION=@OLD_COLLATION_CONNECTION */;
/*!40111 SET SQL_NOTES=@OLD_SQL_NOTES */;

-- Dump completed on 2008-01-10 11:37:06