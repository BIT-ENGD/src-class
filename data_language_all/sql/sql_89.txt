

##############用户 品牌分析
 
 #cnmame <- c("brand_id","active_num","month_num","user_num","uer_active_ratio","buy_convert")
 
 #次数 
 SELECT user_id,brand_id,
 COUNT(1)AS active_num 
 FROM t_alibaba_data 
 GROUP BY user_id, brand_id 
 LIMIT 100;
  
 #用户数
 SELECT brand_id,COUNT(DISTINCT(user_id))AS user_num FROM t_alibaba_data GROUP BY brand_id LIMIT 100;
 
 #月数
 SELECT user_id,
 brand_id,
 COUNT(DISTINCT(MONTH(visit_datetime)))AS month_num 
 FROM t_alibaba_data 
 GROUP BY user_id,brand_id 
 LIMIT 100;
 
 #活跃次数
SELECT user_id,brand_id,
 COUNT(1) AS active_num 
 FROM t_alibaba_data 
 GROUP BY user_id,brand_id 
 LIMIT 100;

#购买次数
SELECT user_id,brand_id,
 COUNT(1)AS buy_num 
 FROM t_alibaba_data 
 WHERE TYPE =1 
 GROUP BY user_id,brand_id 
 LIMIT 100;
 
 #点击数
SELECT user_id,brand_id,
 COUNT(1)AS buy_num 
 FROM t_alibaba_data 
 WHERE TYPE =0
 GROUP BY user_id,brand_id 
 LIMIT 100;
 
 #收藏数
SELECT user_id,brand_id,
 COUNT(1)AS buy_num 
 FROM t_alibaba_data 
 WHERE TYPE =2
 GROUP BY user_id,brand_id 
 LIMIT 100;
 
 #购物车数
SELECT user_id,brand_id,
 COUNT(1)AS buy_num 
 FROM t_alibaba_data 
 WHERE TYPE =3 
 GROUP BY user_id,brand_id 
 LIMIT 100;

--sql2005 and above
select 
	  backuptype 
	, recovery_model_desc
	, OldestLatestBackupDate = MIN(BackupDate)
FROM
(
select 
	database_name
	, backuptype 
	, d.recovery_model_desc
	, BackupDate = MAX(BackupDate)
	, d.state_desc
 from sys.databases d
 inner join 
 (
select distinct 
	database_name
	, backuptype = case type	WHEN 'D' then 'Database'
							WHEN 'I' then 'Differential database'
							WHEN 'L' then 'Transaction Log'
							WHEN 'F' then 'File or filegroup'
							WHEN 'G' then 'Differential file'
							WHEN 'P' then 'Partial'
							WHEN 'Q' then 'Differential partial' END
	, BackupDate	=	MAX(backup_start_date)  	
	from msdb.dbo.backupset bs							
 group by database_name, type
 UNION 
 select distinct
	db_name(d.database_id)
	, backuptype = 'Database'
	, null
	FROM master.sys.databases d
 UNION
 select distinct
	db_name(d.database_id)
	, backuptype = 'Transaction Log'
	, null
  FROM master.sys.databases d
  where d.recovery_model_desc in ('FULL', 'BULK_LOGGED')
  
 ) a
 on db_name(d.database_id) = a.database_name
 WHERE backuptype = 'transaction log'
 group by database_name, backuptype, d.recovery_model_desc, d.state_desc
) x
group by backuptype, recovery_model_desc
order by backuptype, recovery_model_desc

GO

select 
	database_name
	, backuptype 
	, d.recovery_model_desc
	, BackupDate = MAX(BackupDate)
	, d.state_desc
 from sys.databases d
 inner join 
 (
select distinct 
	database_name
	, backuptype = case type	WHEN 'D' then 'Database'
							WHEN 'I' then 'Differential database'
							WHEN 'L' then 'Transaction Log'
							WHEN 'F' then 'File or filegroup'
							WHEN 'G' then 'Differential file'
							WHEN 'P' then 'Partial'
							WHEN 'Q' then 'Differential partial' END
	, BackupDate	=	MAX(backup_start_date)  	
	from msdb.dbo.backupset bs							
 group by database_name, type
 UNION 
 select distinct
	db_name(d.database_id)
	, backuptype = 'Database'
	, null
	FROM master.sys.databases d
 UNION
 select distinct
	db_name(d.database_id)
	, backuptype = 'Transaction Log'
	, null
  FROM master.sys.databases d
  where d.recovery_model_desc in ('FULL', 'BULK_LOGGED')
  
 ) a
 on db_name(d.database_id) = a.database_name
 --WHERE backuptype = 'transaction log'
 group by database_name, backuptype, d.recovery_model_desc, d.state_desc
