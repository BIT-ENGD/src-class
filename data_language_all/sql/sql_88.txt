

##############品牌分析
 
 #cnmame <- c("brand_id","active_num","month_num","user_num","uer_active_ratio","buy_convert")
 
 #次数 
 SELECT brand_id,COUNT(1)AS active_num FROM t_alibaba_data GROUP BY brand_id LIMIT 100;
  
 #用户数
 SELECT brand_id,COUNT(DISTINCT(user_id))AS user_num FROM t_alibaba_data GROUP BY brand_id LIMIT 100;
 
 #月数
 SELECT brand_id,COUNT(DISTINCT(MONTH(visit_datetime)))AS month_num FROM t_alibaba_data GROUP BY brand_id LIMIT 100;
 
 #用户数/次数
user_active_ratio

#购买
SELECT brand_id,
 COUNT(DISTINCT(user_id))AS buy_num 
 FROM t_alibaba_data 
 WHERE TYPE =1 
 AND visit_datetime < "2014-06-15"
 GROUP BY brand_id 
 LIMIT 100;


#整体
SELECT brand_id,
 COUNT(1)AS active_num , 
 COUNT(DISTINCT(user_id))AS user_num , 
 COUNT(DISTINCT(MONTH(visit_datetime)))AS month_num,
 COUNT(DISTINCT(user_id))/COUNT(1) AS user_active_ratio
 FROM t_alibaba_data  
 WHERE visit_datetime < "2014-06-15"
 GROUP BY brand_id
LIMIT 100


#最后一次活动时间
SELECT user_id,brand_id,DATEDIFF("2014-06-15",MAX(visit_datetime))
AS lastday 
FROM t_alibaba_data 
WHERE visit_datetime < "2014-06-15"
GROUP BY user_id,brand_id 
LIMIT 100;

#近3天的活跃次数
SELECT user_id,brand_id,
COUNT(CASE WHEN TYPE = 0 THEN 1  END) AS last_3_day_click_times ,
COUNT(CASE WHEN TYPE = 1 THEN 1  END) AS last_3_day_buy_times ,
COUNT(CASE WHEN TYPE = 2 THEN 1  END) AS last_3_day_collect_times ,
COUNT(CASE WHEN TYPE = 3 THEN 1  END) AS last_3_day_cart_times 
FROM t_alibaba_data 
WHERE visit_datetime < "2014-06-15"
AND visit_datetime > "2014-06-11"
GROUP BY user_id,brand_id 
LIMIT 100;

#近7天的活跃次数
SELECT user_id,brand_id,
COUNT(CASE WHEN TYPE = 0 THEN 1  END) AS last_7_day_click_times ,
COUNT(CASE WHEN TYPE = 1 THEN 1  END) AS last_7_day_buy_times ,
COUNT(CASE WHEN TYPE = 2 THEN 1  END) AS last_7_day_collect_times ,
COUNT(CASE WHEN TYPE = 3 THEN 1  END) AS last_7_day_cart_times 
FROM t_alibaba_data 
WHERE visit_datetime < "2014-06-15"
AND visit_datetime > "2014-06-07"
GROUP BY user_id,brand_id 
LIMIT 100;

#近15天的活跃次数
SELECT user_id,brand_id,
COUNT(CASE WHEN TYPE = 0 THEN 1  END) AS last_15_day_click_times ,
COUNT(CASE WHEN TYPE = 1 THEN 1  END) AS last_15_day_buy_times ,
COUNT(CASE WHEN TYPE = 2 THEN 1  END) AS last_15_day_collect_times ,
COUNT(CASE WHEN TYPE = 3 THEN 1  END) AS last_15_day_cart_times 
FROM t_alibaba_data 
WHERE visit_datetime < "2014-06-15"
AND visit_datetime > "2014-05-30"
GROUP BY user_id,brand_id 
LIMIT 100;

#近30天的活跃次数
SELECT user_id,brand_id,
COUNT(CASE WHEN TYPE = 0 THEN 1  END) AS last_30_day_click_times ,
COUNT(CASE WHEN TYPE = 1 THEN 1  END) AS last_30_day_buy_times ,
COUNT(CASE WHEN TYPE = 2 THEN 1  END) AS last_30_day_collect_times ,
COUNT(CASE WHEN TYPE = 3 THEN 1  END) AS last_30_day_cart_times 
FROM t_alibaba_data 
WHERE visit_datetime < "2014-06-15"
AND visit_datetime > "2014-05-15"
GROUP BY user_id,brand_id 
LIMIT 100;

#所有
SELECT user_id,brand_id,
COUNT(CASE WHEN TYPE = 0 THEN 1  END) AS total_click_times ,
COUNT(CASE WHEN TYPE = 1 THEN 1  END) AS total_buy_times ,
COUNT(CASE WHEN TYPE = 2 THEN 1  END) AS total_collect_times ,
COUNT(CASE WHEN TYPE = 3 THEN 1  END) AS total_cart_times 
FROM t_alibaba_data 
WHERE visit_datetime < "2014-06-15"
GROUP BY user_id,brand_id 
LIMIT 100;--https://msdn.microsoft.com/en-us/library/dn800981.aspx
--Run in the master Azure SQL server database
select 
	Database_Name
,	sku --Basic, Standard, Premium
,	TierDTU	= dtu_limit
,	Storage_in_mb			=	MAX(Storage_in_megabytes)
,	'Average CPU Utilization In %'			=	AVG(avg_cpu_percent)			
,	'Maximum CPU Utilization In %'			=	MAX(avg_cpu_percent)			
,	'Average Data IO In %'					=	AVG(avg_data_io_percent)		
,	'Maximum Data IO In %'					=	MAX(avg_data_io_percent)		
,	'Average Log Write Utilization In %'	=	AVG(avg_log_write_percent)		   
,	'Maximum Log Write Utilization In %'	=	MAX(avg_log_write_percent)		   
,	'Average Requests In %'					=	AVG(max_worker_percent)	
,	'Maximum Requests In %'					=	MAX(max_worker_percent)	
,	'Average Sessions In %'					=	AVG(max_session_percent)	
,	'Maximum Sessions In %'					=	MAX(max_session_percent)	
--select *
from 
master.sys.resource_stats as rs  --past 14 days 
group by Database_Name, sku, dtu_limit
order by Database_Name desc

select 
	Timestamp				=	datetimefromparts(year(rs.end_time), month(rs.end_time), day(rs.end_time), datepart(hh,rs.end_time), 0,0,0)
,	Database_Name
,	sku --Basic, Standard, Premium
,	TierDTU					= dtu_limit
,	Storage_in_mb			=	MAX(Storage_in_megabytes)
,	'Average CPU Utilization In %'			=	AVG(avg_cpu_percent)			
,	'Maximum CPU Utilization In %'			=	MAX(avg_cpu_percent)			
,	'Average Data IO In %'					=	AVG(avg_data_io_percent)		
,	'Maximum Data IO In %'					=	MAX(avg_data_io_percent)		
,	'Average Log Write Utilization In %'	=	AVG(avg_log_write_percent)		   
,	'Maximum Log Write Utilization In %'	=	MAX(avg_log_write_percent)		   
,	'Average Requests In %'					=	AVG(max_worker_percent)	
,	'Maximum Requests In %'					=	MAX(max_worker_percent)	
,	'Average Sessions In %'					=	AVG(max_session_percent)	
,	'Maximum Sessions In %'					=	MAX(max_session_percent)	
--select *
from 
master.sys.resource_stats as rs  --past 14 days only
group by Database_Name, sku, dtu_limit, datetimefromparts(year(rs.end_time), month(rs.end_time), day(rs.end_time), datepart(hh,rs.end_time), 0,0,0)
order by Database_Name desc, TimeStamp DESC 

