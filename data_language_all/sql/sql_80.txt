-- Throne of the Tides
UPDATE `creature_template` SET `flags_extra`=`flags_extra`|0x1 WHERE `entry` IN (40765, 40825, 40586, 40788, 44566);

-- Blackrock Caverns
UPDATE `creature_template` SET `flags_extra`=`flags_extra`|0x1 WHERE `entry` IN (39705, 39700, 39679, 39698, 39665);

-- End Time
UPDATE `creature_template` SET `flags_extra`=`flags_extra`|0x1 WHERE `entry` IN (54431, 54445, 54123, 54544, 54432);

-- Grim Batol
UPDATE `creature_template` SET `flags_extra`=`flags_extra`|0x1 WHERE `entry` IN (40319, 40484, 40177, 39625);

-- Halls of Origination
UPDATE `creature_template` SET `flags_extra`=`flags_extra`|0x1 WHERE `entry` IN (39731, 39788, 39428, 39587, 39378, 39732, 39425);

-- Hour of Twilight
UPDATE `creature_template` SET `flags_extra`=`flags_extra`|0x1 WHERE `entry` IN (54938, 54590, 54968);

-- Lost City of the Tol'vir
UPDATE `creature_template` SET `flags_extra`=`flags_extra`|0x1 WHERE `entry` IN (49045, 44577, 43612, 43614, 44819);

-- The Stonecore
UPDATE `creature_template` SET `flags_extra`=`flags_extra`|0x1 WHERE `entry` IN (43438, 42333, 42188, 43214);

-- The Vortex Pinnacle
UPDATE `creature_template` SET `flags_extra`=`flags_extra`|0x1 WHERE `entry` IN (43873, 43875, 43878);

-- Well of Eternity
UPDATE `creature_template` SET `flags_extra`=`flags_extra`|0x1 WHERE `entry` IN (55419, 54969, 55085, 54853);

-- Baradin Hold
UPDATE `creature_template` SET `flags_extra`=`flags_extra`|0x1 WHERE `entry` IN (55869, 47120, 52363);

-- Blackwing Descent
UPDATE `creature_template` SET `flags_extra`=`flags_extra`|0x1 WHERE `entry` IN (42166, 41442, 43296, 42179, 42178, 41570, 41378, 41376, 41270, 42180);

-- Dragon Soul
UPDATE `creature_template` SET `flags_extra`=`flags_extra`|0x1 WHERE `entry` IN (56173, 53879, 55689, 55265, 55294, 55308, 56427, 55312);

-- Firelands
UPDATE `creature_template` SET `flags_extra`=`flags_extra`|0x1 WHERE `entry` IN (52530, 53494, 52498, 52558, 52571, 52409, 53691);

-- The Bastion of Twilight
UPDATE `creature_template` SET `flags_extra`=`flags_extra`|0x1 WHERE `entry` IN (43688, 43324, 43735, 43687, 44600, 43686, 45213, 43689, 45993, 45992);

-- Throne of the Four Winds
UPDATE `creature_template` SET `flags_extra`=`flags_extra`|0x1 WHERE `entry` IN (46753, 45870, 45871, 45872);


##############用户&品牌分析


#############

SELECT 
a.user_id,
a.brand_id,
lastday,
month_count,
last_3_day_click_times,
last_3_day_buy_times,
last_3_day_collect_times,
last_3_day_cart_times,
last_7_day_click_times,
last_7_day_buy_times,
last_7_day_collect_times,
last_7_day_cart_times,
last_15_day_click_times,
last_15_day_buy_times,
last_15_day_collect_times,
last_15_day_cart_times,
last_30_day_click_times,
last_30_day_buy_times,
last_30_day_collect_times,
last_30_day_cart_times,
total_click_times,
total_buy_times,
total_collect_times,
total_cart_times,
buy_times
FROM 
 (SELECT user_id,brand_id,DATEDIFF("2014-06-15",MAX(visit_datetime))
AS lastday 
FROM t_alibaba_data 
WHERE visit_datetime < "2014-06-15"
GROUP BY user_id,brand_id)
AS a 
LEFT JOIN
(SELECT user_id,brand_id,
COUNT(CASE WHEN TYPE = 0 THEN 1  END) AS last_3_day_click_times ,
COUNT(CASE WHEN TYPE = 1 THEN 1  END) AS last_3_day_buy_times ,
COUNT(CASE WHEN TYPE = 2 THEN 1  END) AS last_3_day_collect_times ,
COUNT(CASE WHEN TYPE = 3 THEN 1  END) AS last_3_day_cart_times 
FROM t_alibaba_data 
WHERE visit_datetime < "2014-06-15"
AND visit_datetime > "2014-06-11"
GROUP BY user_id,brand_id )
AS b 
ON a.user_id = b.user_id AND a.brand_id = b.brand_id
LEFT  JOIN
(SELECT user_id,brand_id,
COUNT(CASE WHEN TYPE = 0 THEN 1  END) AS last_7_day_click_times ,
COUNT(CASE WHEN TYPE = 1 THEN 1  END) AS last_7_day_buy_times ,
COUNT(CASE WHEN TYPE = 2 THEN 1  END) AS last_7_day_collect_times ,
COUNT(CASE WHEN TYPE = 3 THEN 1  END) AS last_7_day_cart_times 
FROM t_alibaba_data 
WHERE visit_datetime < "2014-06-15"
AND visit_datetime > "2014-06-07"
GROUP BY user_id,brand_id )
AS c
ON a.user_id = c.user_id AND a.brand_id = c.brand_id
LEFT JOIN
(SELECT user_id,brand_id,
COUNT(CASE WHEN TYPE = 0 THEN 1  END) AS last_15_day_click_times ,
COUNT(CASE WHEN TYPE = 1 THEN 1  END) AS last_15_day_buy_times ,
COUNT(CASE WHEN TYPE = 2 THEN 1  END) AS last_15_day_collect_times ,
COUNT(CASE WHEN TYPE = 3 THEN 1  END) AS last_15_day_cart_times 
FROM t_alibaba_data 
WHERE visit_datetime < "2014-06-15"
AND visit_datetime > "2014-05-30"
GROUP BY user_id,brand_id )
AS d 
ON a.user_id = d.user_id AND a.brand_id = d.brand_id
LEFT JOIN 
(SELECT user_id,brand_id,
COUNT(CASE WHEN TYPE = 0 THEN 1  END) AS last_30_day_click_times ,
COUNT(CASE WHEN TYPE = 1 THEN 1  END) AS last_30_day_buy_times ,
COUNT(CASE WHEN TYPE = 2 THEN 1  END) AS last_30_day_collect_times ,
COUNT(CASE WHEN TYPE = 3 THEN 1  END) AS last_30_day_cart_times 
FROM t_alibaba_data 
WHERE visit_datetime < "2014-06-15"
AND visit_datetime > "2014-05-15"
GROUP BY user_id,brand_id )
AS e 
ON a.user_id = e.user_id AND a.brand_id = e.brand_id
LEFT JOIN 
(SELECT user_id,brand_id,
COUNT(CASE WHEN TYPE = 0 THEN 1  END) AS total_click_times ,
COUNT(CASE WHEN TYPE = 1 THEN 1  END) AS total_buy_times ,
COUNT(CASE WHEN TYPE = 2 THEN 1  END) AS total_collect_times ,
COUNT(CASE WHEN TYPE = 3 THEN 1  END) AS total_cart_times 
FROM t_alibaba_data 
WHERE visit_datetime < "2014-06-15"
GROUP BY user_id,brand_id )
AS f 
ON a.user_id = f.user_id AND a.brand_id = f.brand_id
LEFT JOIN 
(SELECT user_id,brand_id,
COUNT(1) AS buy_times 
FROM t_alibaba_data 
WHERE visit_datetime >= "2014-06-15"
AND visit_datetime < "2014-07-15"
AND TYPE = 1
GROUP BY user_id,brand_id)
AS g 
ON a.user_id = g.user_id AND a.brand_id = g.brand_id
LEFT JOIN 
(SELECT user_id,
 brand_id,
 COUNT(DISTINCT(MONTH(visit_datetime)))AS month_count 
 FROM t_alibaba_data 
 WHERE visit_datetime < "2014-06-15"
 GROUP BY user_id,brand_id)
AS h 
ON a.user_id = h.user_id AND a.brand_id = h.brand_id 

 





#########################################分步实现 


 #月数
 SELECT user_id,
 brand_id,
 COUNT(DISTINCT(MONTH(visit_datetime)))AS month_count 
 FROM t_alibaba_data 
 WHERE visit_datetime < "2014-06-15"
 GROUP BY user_id,brand_id 
 LIMIT 100;
 
 
#最后一次活动时间
SELECT user_id,brand_id,DATEDIFF("2014-06-15",MAX(visit_datetime))
AS lastday 
FROM t_alibaba_data 
WHERE visit_datetime < "2014-06-15"
GROUP BY user_id,brand_id 
LIMIT 100;

#近3天的活跃次数
SELECT user_id,brand_id,
COUNT(CASE WHEN TYPE = 0 THEN 1  END) AS last_3_day_click_times ,
COUNT(CASE WHEN TYPE = 1 THEN 1  END) AS last_3_day_buy_times ,
COUNT(CASE WHEN TYPE = 2 THEN 1  END) AS last_3_day_collect_times ,
COUNT(CASE WHEN TYPE = 3 THEN 1  END) AS last_3_day_cart_times 
FROM t_alibaba_data 
WHERE visit_datetime < "2014-06-15"
AND visit_datetime > "2014-06-11"
GROUP BY user_id,brand_id 
LIMIT 100;

#近7天的活跃次数
SELECT user_id,brand_id,
COUNT(CASE WHEN TYPE = 0 THEN 1  END) AS last_7_day_click_times ,
COUNT(CASE WHEN TYPE = 1 THEN 1  END) AS last_7_day_buy_times ,
COUNT(CASE WHEN TYPE = 2 THEN 1  END) AS last_7_day_collect_times ,
COUNT(CASE WHEN TYPE = 3 THEN 1  END) AS last_7_day_cart_times 
FROM t_alibaba_data 
WHERE visit_datetime < "2014-06-15"
AND visit_datetime > "2014-06-07"
GROUP BY user_id,brand_id 
LIMIT 100;

#近15天的活跃次数
SELECT user_id,brand_id,
COUNT(CASE WHEN TYPE = 0 THEN 1  END) AS last_15_day_click_times ,
COUNT(CASE WHEN TYPE = 1 THEN 1  END) AS last_15_day_buy_times ,
COUNT(CASE WHEN TYPE = 2 THEN 1  END) AS last_15_day_collect_times ,
COUNT(CASE WHEN TYPE = 3 THEN 1  END) AS last_15_day_cart_times 
FROM t_alibaba_data 
WHERE visit_datetime < "2014-06-15"
AND visit_datetime > "2014-05-30"
GROUP BY user_id,brand_id 
LIMIT 100;

#近30天的活跃次数
SELECT user_id,brand_id,
COUNT(CASE WHEN TYPE = 0 THEN 1  END) AS last_30_day_click_times ,
COUNT(CASE WHEN TYPE = 1 THEN 1  END) AS last_30_day_buy_times ,
COUNT(CASE WHEN TYPE = 2 THEN 1  END) AS last_30_day_collect_times ,
COUNT(CASE WHEN TYPE = 3 THEN 1  END) AS last_30_day_cart_times 
FROM t_alibaba_data 
WHERE visit_datetime < "2014-06-15"
AND visit_datetime > "2014-05-15"
GROUP BY user_id,brand_id 
LIMIT 100;

#所有
SELECT user_id,brand_id,
COUNT(CASE WHEN TYPE = 0 THEN 1  END) AS total_click_times ,
COUNT(CASE WHEN TYPE = 1 THEN 1  END) AS total_buy_times ,
COUNT(CASE WHEN TYPE = 2 THEN 1  END) AS total_collect_times ,
COUNT(CASE WHEN TYPE = 3 THEN 1  END) AS total_cart_times 
FROM t_alibaba_data 
WHERE visit_datetime < "2014-06-15"
GROUP 