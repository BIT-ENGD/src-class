COMMENT ON COLUMN geoheader.fileid IS 'Always equal to ACS Summary File identification';
COMMENT ON COLUMN geoheader.stusab IS 'State Postal Abbreviation';
COMMENT ON COLUMN geoheader.sumlevel IS 'Summary Level';
COMMENT ON COLUMN geoheader.component IS 'Geographic Component';
COMMENT ON COLUMN geoheader.logrecno IS 'Logical Record Number';
COMMENT ON COLUMN geoheader.us IS 'US';
COMMENT ON COLUMN geoheader.region IS 'Census Region';
COMMENT ON COLUMN geoheader.division IS 'Census Division';
COMMENT ON COLUMN geoheader.statece IS 'State (Census Code)';
COMMENT ON COLUMN geoheader.state IS 'State (FIPS Code)';
COMMENT ON COLUMN geoheader.county IS 'County of current residence';
COMMENT ON COLUMN geoheader.cousub IS 'County Subdivision (FIPS)';
COMMENT ON COLUMN geoheader.place IS 'Place (FIPS Code)';
COMMENT ON COLUMN geoheader.tract IS 'Census Tract';
COMMENT ON COLUMN geoheader.blkgrp IS 'Block Group';
COMMENT ON COLUMN geoheader.concit IS 'Consolidated City';
COMMENT ON COLUMN geoheader.aianhh IS 'American Indian Area/Alaska Native Area/ Hawaiian Home Land (Census)';
COMMENT ON COLUMN geoheader.aianhhfp IS 'American Indian Area/Alaska Native Area/ Hawaiian Home Land (FIPS)';
COMMENT ON COLUMN geoheader.aihhtli IS 'American Indian Trust Land/ Hawaiian Home Land Indicator';
COMMENT ON COLUMN geoheader.aitsce IS 'American Indian Tribal Subdivision (Census)';
COMMENT ON COLUMN geoheader.aits IS 'American Indian Tribal Subdivision (FIPS)';
COMMENT ON COLUMN geoheader.anrc IS 'Alaska Native Regional Corporation (FIPS)';
COMMENT ON COLUMN geoheader.cbsa IS 'Metropolitan and Micropolitan Statistical Area';
COMMENT ON COLUMN geoheader.csa IS 'Combined Statistical Area';
COMMENT ON COLUMN geoheader.metdiv IS 'Metropolitan Statistical Area-Metropolitan Division';
COMMENT ON COLUMN geoheader.macc IS 'Metropolitan Area Central City';
COMMENT ON COLUMN geoheader.memi IS 'Metropolitan/Micropolitan Indicator Flag';
COMMENT ON COLUMN geoheader.necta IS 'New England City and Town Area';
COMMENT ON COLUMN geoheader.cnecta IS 'New England City and Town Combined Statistical Area';
COMMENT ON COLUMN geoheader.nectadiv IS 'New England City and Town Area Division';
COMMENT ON COLUMN geoheader.ua IS 'Urban Area';
COMMENT ON COLUMN geoheader.blank1 IS 'Reserved for future use';
COMMENT ON COLUMN geoheader.cdcurr IS 'Current Congressional District ***';
COMMENT ON COLUMN geoheader.sldu IS 'State Legislative District Upper';
COMMENT ON COLUMN geoheader.sldl IS 'State Legislative District Lower';
COMMENT ON COLUMN geoheader.blank2 IS 'Reserved for future use';
COMMENT ON COLUMN geoheader.blank3 IS 'Reserved for future use';
COMMENT ON COLUMN geoheader.zcta5 IS '5-digit ZIP Code Tabulation Area';
COMMENT ON COLUMN geoheader.submcd IS 'Subminor Civil Division (FIPS)';
COMMENT ON COLUMN geoheader.sdelm IS 'State-School District (Elementary)';
COMMENT ON COLUMN geoheader.sdsec IS 'State-School District (Secondary)';
COMMENT ON COLUMN geoheader.sduni IS 'State-School District (Unified)';
COMMENT ON COLUMN geoheader.ur IS 'Urban/Rural';
COMMENT ON COLUMN geoheader.pci IS 'Principal City Indicator';
COMMENT ON COLUMN geoheader.blank5 IS 'Reserved for future use';
COMMENT ON COLUMN geoheader.blank6 IS 'Reserved for future use';
COMMENT ON COLUMN geoheader.puma5 IS 'Public Use Microdata Area - 5% File';
COMMENT ON COLUMN geoheader.blank7 IS 'Reserved for future use';
COMMENT ON COLUMN geoheader.geoid IS 'Geographic Identifier';
COMMENT ON COLUMN geoheader.name IS 'Area Name';
COMMENT ON COLUMN geoheader.bttr IS 'Tribal Tract';
COMMENT ON COLUMN geoheader.btbg IS 'Tribal Block Group';
COMMENT ON COLUMN geoheader.blank8 IS 'Reserved for future use';

/* works fine using total_keyword_seaches_view */

SELECT z.AccessDateTime, z.Keyword, z.Series_Code, z.total_searches, z.sum_link
	  ,COUNT(z.Unique_CodeFix) AS Total_CodeFix_Count, COUNT(z.Tab_name_count) AS Total_Tab_name_count

FROM

(	SELECT s.*, t.total_searches, t.sum_link, c.Unique_CodeFix, d.Tab_name_count 
	FROM search s
	JOIN total_keyword_searches 
	AS t ON s.Keyword = t.Keyword AND s.Series_Code <> ''

	LEFT JOIN(
		SELECT DISTINCT AccessDateTime, SessionId, Series_Code, Referer_URL, Product_Code
				, COUNT(DISTINCT Product_Code) AS Unique_CodeFix
		FROM code_fix
		GROUP BY SessionId, Series_Code, Referer_URL, Product_Code
		ORDER BY Series_Code DESC
	) AS c ON s.SessionId = c.SessionId AND s.URL = c.Referer_URL 

	LEFT JOIN (
		SELECT 	SessionId#, Page_URL
				,Tab_Name, Series_Code
			   ,COUNT(DISTINCT Tab_Name) AS Tab_name_count
		FROM detail_tab
		WHERE Tab_Name = '4' 
		GROUP BY SessionId, Series_Code, Tab_Name
	) AS d ON s.SessionId = d.SessionId AND s.Series_Code = d.Series_Code 
																				 
	GROUP BY s.Keyword, s.Series_Code, s.URL

) AS z
#WHERE z.Keyword IN ('FEP')
GROUP BY z.Keyword, z.Series_Code
ORDER BY z.total_searches DESC, z.keyword DESC
;



/* works fine, per session and ignoring total searches that resutls blank series code */
/* to get the total searches use the view total_keyword_searches and removing session_id = session_id */

SELECT z.AccessDateTime, z.Keyword, z.Series_Code, z.total_searches, z.sum_link

	,COUNT(z.Unique_CodeFix) AS Total_CodeFix_Count, COUNT(z.Tab_name_count) AS Total_Tab_name_count

FROM

(
	SELECT s.*, t.total_searches, t.sum_link, c.Unique_CodeFix, d.Tab_name_count 

	FROM search s

	JOIN total_keyword_searches_by_session 

	AS t ON s.Keyword = t.Keyword AND s.SessionId = t.SessionId AND s.Series_Code <> ''

	LEFT JOIN(
		SELECT DISTINCT AccessDateTime, SessionId, Series_Code, Referer_URL, Product_Code
				, COUNT(DISTINCT Product_Code) AS Unique_CodeFix
		FROM code_fix
		GROUP BY SessionId, Series_Code, Referer_URL, Product_Code
		ORDER BY Series_Code DESC
	) AS c ON s.SessionId = c.SessionId AND s.URL = c.Referer_URL 

	LEFT JOIN (
		SELECT 	SessionId#, Page_URL
				,Tab_Name, Series_Code
			   ,COUNT(DISTINCT Tab_Name) AS Tab_name_count
		FROM detail_tab
		WHERE Tab_Name = '4' 
		GROUP BY SessionId, Series_Code, Tab_Name
	) AS d ON s.SessionId = d.SessionId AND s.Series_Code = d.Series_Code 
																							 
	#Where s.Keyword in ('anb', 'CLBU8-11-10') #and s.Series_Code <> ''

	GROUP BY s.Keyword, s.Series_Code, s.URL
)
AS z
WHERE z.Keyword IN ('CLBU8-11-10', 'ABHPL', 'bushing','anb')
GROUP BY z.Keyword, z.Series_Code
ORDER BY z.total_searches DESC, z.keyword DESC
;



# Prior version of above query is 


SELECT *#s.*, c.Unique_CodeFix, d.Tab_name_count

	FROM search s

	JOIN total_keyword_searches_by_session 

	AS t ON s.Keyword = t.Keyword AND s.SessionId = t.SessionId AND s.Series_Code <> ''

	LEFT JOIN(
		SELECT DISTINCT AccessDateTime, SessionId, Series_Code, Referer_URL, Product_Code
				, COUNT(DISTINCT Product_Code) AS Unique_CodeFix
		FROM code_fix
		GROUP BY SessionId, Series_Code, Referer_URL, Product_Code
		ORDER BY Series_Code DESC
	) AS c ON s.SessionId = c.SessionId AND s.URL = c.Referer_URL 

	LEFT JOIN (
		SELECT 	SessionId#, Page_URL
				,Tab_Name, Series_Code
			   ,COUNT(DISTINCT Tab_Name) AS Tab_name_count
		FROM detail_tab
		WHERE Tab_Name = '4' 
		GROUP BY SessionId, Series_Code, Tab_Name
	) AS d ON s.SessionId = d.SessionId AND s.Series_Code = d.Series_Code 
																							 
	WHERE s.Keyword IN ('anb', 'CLBU8-11-10', 'ABHPL') #and s.Series_Code <> ''

	GROUP BY s.Keyword, s.Series_Code, s.URL

CREATE VIEW total_keyword_searches_by_session AS

	SELECT DISTINCT s.SessionId, s.Keyword, s.Series_Code
			,(SUM(IF(s.Status = 'Hit',1,0)) + SUM(IF(s.Status = 'NotFound',1,0))) AS total_searches	
			, SUM(IF(s.Status = 'Link',1,0)) AS sum_Link
	FROM search s
	#Where s.Keyword in ('anb', 'CLBU8-11-10')
	GROUP BY s.Keyword, s.SessionId;


CREATE VIEW total_keyword_searches AS

	SELECT DISTINCT s.SessionId, s.Keyword, s.Series_Code
			,(SUM(IF(s.Status = 'Hit',1,0)) + SUM(IF(s.Status = 'NotFound',1,0))) AS total_searches	
			, SUM(IF(s.Status = 'Link',1,0)) AS sum_Link
	FROM search s
	#Where s.Keyword in ('anb', 'CLBU8-11-10')
	GROUP BY s.Keyword;


	SELECT 	d.SessionId#, Page_URL
			,d.Tab_Name
			,d.Series_Code
		   ,COUNT(DISTINCT Tab_Name) AS Tab_name_count
	FROM detail_tab d
	WHERE d.Tab_Name = '4' 
		 AND d.SessionId IN ('79cd94d793c9984c833eb5da9eafabf3')#, '7d981db72a5c5797d340619b603e12bf');
	GROUP BY d.SessionId, d.Series_Code, d.Tab_Name;



	SELECT DISTINCT c.SessionId, c.Series_Code, c.Referer_URL
			#, COUNT(DISTINCT c.Product_Code) AS Unique_CodeFix
	FROM code_fix c
	WHERE c.SessionId IN ('79cd94d793c9984c833eb5da9eafabf3')#, '7d981db72a5c5797d340619b603e12bf');
	GROUP BY c.SessionId, c.Series_Code, c.Referer_URL
	ORDER BY c.Series_Code DESC;

