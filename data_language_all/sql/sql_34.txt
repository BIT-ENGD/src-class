INSERT INTO geoheader SELECT
	btrim(substring(all_fields from 1 for 6)) AS fileid,
	btrim(substring(all_fields from 7 for 2)) AS stusab,
	btrim(substring(all_fields from 9 for 3))::int AS sumlevel,
	btrim(substring(all_fields from 12 for 2)) AS component,
	btrim(substring(all_fields from 14 for 7))::int AS logrecno,
	NULLIF(btrim(substring(all_fields from 21 for 1)), '') AS us,
	NULLIF(btrim(substring(all_fields from 22 for 1)), '') AS region,
	NULLIF(btrim(substring(all_fields from 23 for 1)), '') AS division,
	NULLIF(btrim(substring(all_fields from 24 for 2)), '') AS statece,
	NULLIF(btrim(substring(all_fields from 26 for 2)), '') AS state,
	NULLIF(btrim(substring(all_fields from 28 for 3)), '') AS county,
	NULLIF(btrim(substring(all_fields from 31 for 5)), '') AS cousub,
	NULLIF(btrim(substring(all_fields from 36 for 5)), '') AS place,
	NULLIF(btrim(substring(all_fields from 41 for 6)), '') AS tract,
	NULLIF(btrim(substring(all_fields from 47 for 1)), '') AS blkgrp,
	NULLIF(btrim(substring(all_fields from 48 for 5)), '') AS concit,
	NULLIF(btrim(substring(all_fields from 53 for 4)), '') AS aianhh,
	NULLIF(btrim(substring(all_fields from 57 for 5)), '') AS aianhhfp,
	NULLIF(btrim(substring(all_fields from 62 for 1)), '') AS aihhtli,
	NULLIF(btrim(substring(all_fields from 63 for 3)), '') AS aitsce,
	NULLIF(btrim(substring(all_fields from 66 for 5)), '') AS aits,
	NULLIF(btrim(substring(all_fields from 71 for 5)), '') AS anrc,
	NULLIF(btrim(substring(all_fields from 76 for 5)), '') AS cbsa,
	NULLIF(btrim(substring(all_fields from 81 for 3)), '') AS csa,
	NULLIF(btrim(substring(all_fields from 84 for 5)), '') AS metdiv,
	NULLIF(btrim(substring(all_fields from 89 for 1)), '') AS macc,
	NULLIF(btrim(substring(all_fields from 90 for 1)), '') AS memi,
	NULLIF(btrim(substring(all_fields from 91 for 5)), '') AS necta,
	NULLIF(btrim(substring(all_fields from 96 for 3)), '') AS cnecta,
	NULLIF(btrim(substring(all_fields from 99 for 5)), '') AS nectadiv,
	NULLIF(btrim(substring(all_fields from 104 for 5)), '') AS ua,
	NULLIF(btrim(substring(all_fields from 109 for 5)), '') AS blank1,
	NULLIF(btrim(substring(all_fields from 114 for 2)), '') AS cdcurr,
	NULLIF(btrim(substring(all_fields from 116 for 3)), '') AS sldu,
	NULLIF(btrim(substring(all_fields from 119 for 3)), '') AS sldl,
	NULLIF(btrim(substring(all_fields from 122 for 6)), '') AS blank2,
	NULLIF(btrim(substring(all_fields from 128 for 3)), '') AS blank3,
	NULLIF(btrim(substring(all_fields from 131 for 5)), '') AS zcta5,
	NULLIF(btrim(substring(all_fields from 136 for 5)), '') AS submcd,
	NULLIF(btrim(substring(all_fields from 141 for 5)), '') AS sdelm,
	NULLIF(btrim(substring(all_fields from 146 for 5)), '') AS sdsec,
	NULLIF(btrim(substring(all_fields from 151 for 5)), '') AS sduni,
	NULLIF(btrim(substring(all_fields from 156 for 1)), '') AS ur,
	NULLIF(btrim(substring(all_fields from 157 for 1)), '') AS pci,
	NULLIF(btrim(substring(all_fields from 158 for 6)), '') AS blank5,
	NULLIF(btrim(substring(all_fields from 164 for 5)), '') AS blank6,
	NULLIF(btrim(substring(all_fields from 169 for 5)), '') AS puma5,
	NULLIF(btrim(substring(all_fields from 174 for 5)), '') AS blank7,
	NULLIF(btrim(substring(all_fields from 179 for 40)), '') AS geoid,
	NULLIF(btrim(substring(all_fields from 219 for 1000)), '') AS name,
	NULLIF(btrim(substring(all_fields from 1219 for 6)), '') AS bttr,
	NULLIF(btrim(substring(all_fields from 1225 for 1)), '') AS btbg,
	NULLIF(btrim(substring(all_fields from 1226 for 44)), '') AS blank8
FROM tmp_geoheader
select count(*) from search;

/* Super Useful stuff for Analysis 2 */
SELECT DISTINCT s.AccessDateTime,  s.SessionId, Keyword, s.Series_Code, c.Product_Code
			,(SUM(IF(Status = 'Hit',1,0)) + SUM(IF(Status = 'NotFound',1,0))) AS total_searches	
			, SUM(IF(Status = 'LinkCtg',1,0)) AS sum_LinkCtg
			, SUM(IF(Status = 'Link',1,0)) AS sum_Link
			, Status
	FROM search s 
LEFT JOIN(

	SELECT DISTINCT AccessDateTime, SessionId, Series_Code, Referer_URL, Product_Code
			, COUNT(Product_Code) AS CodeFix_count
	FROM code_fix
	#WHERE SessionId in ('d3989cf8ef244653efac851f9b9cdb9e')#('429b8c6e35e835539dd232ef966fe811', 'd3989cf8ef244653efac851f9b9cdb9e', 'ce24d624af0d234b1823e273bf354cbb') 
	GROUP BY SessionId, Series_Code, Referer_URL

) As c On s.SessionId = c.SessionId and (s.Series_Code = c.Series_Code or s.URL = c.Referer_URL)

	WHERE #s.SessionId in ('d3989cf8ef244653efac851f9b9cdb9e') and 
	Keyword = 'fep'
	GROUP BY s.Keyword #, s.SessionId
;

SELECT DISTINCT Keyword, Series_Code
			,(SUM(IF(Status = 'Hit',1,0)) + SUM(IF(Status = 'NotFound',1,0))) AS total_searches	
			, SUM(IF(Status = 'LinkCtg',1,0)) AS sum_LinkCtg
			, SUM(IF(Status = 'Link',1,0)) AS sum_Link
			, Status
	FROM search 
	where Keyword = 'fep'
	GROUP BY Keyword, Series_Code;

/* Super useful ends here */

SELECT 	s.Keyword 
		#,d.Tab_name_count
		, d.Series_Code
		,s1.total_searches
		,d.Link_count
		#,count(d.Tab_name_count)
		,c.CodeFix_count
		#,c.Product_Code
		,d.Tab_Name

FROM search AS s 

LEFT JOIN (
	SELECT DISTINCT	SessionId, Keyword
			,(SUM(IF(Status = 'Hit',1,0)) + SUM(IF(Status = 'NotFound',1,0))) AS total_searches	
			, Status
	FROM search 
	GROUP BY SessionId, Keyword, Status
	
) AS s1 ON s1.Keyword = s.Keyword

LEFT JOIN (

	SELECT 	SessionId, Page_URL
			,Tab_Name
			, Series_Code
		   ,COUNT(DISTINCT Tab_Name) AS Tab_name_count
		   ,COUNT(*) AS Link_count 
	FROM detail_tab
	GROUP BY SessionId, Series_Code, Tab_Name

) AS d ON s.SessionId = d.SessionId AND s.Series_Code = d.Series_Code 


LEFT JOIN(
	SELECT DISTINCT AccessDateTime, SessionId, Series_Code, Referer_URL, Product_Code
			, COUNT(Product_Code) AS CodeFix_count
	FROM code_fix
	GROUP BY SessionId, Series_Code #, Product_Code
) AS c ON s.SessionId = c.SessionId AND (s.Series_Code = c.Series_Code)


WHERE d.Tab_Name = '4' 
	  and s.SessionId = 'cc849a928f720eda3115bf33aed908c1' 	
	  #and s.Keyword = 'stop blocks'

GROUP BY s.Keyword, d.Series_Code, c.Product_Code
ORDER BY s.Keyword ASC, s1.total_searches DESC
; 



# code fix count 
SELECT DISTINCT AccessDateTime, SessionId, Series_Code, Referer_URL, Product_Code
	, COUNT(Product_Code) AS CodeFix_count
			
	FROM code_fix

WHERE # Limiting results to Link only for now 
	  SessionId = 'cc849a928f720eda3115bf33aed908c1' 	
	  AND Series_Code = 110300593810

	GROUP BY SessionId, Series_Code, Product_Code;




# sum hit thingy 
SELECT 	SessionId, Keyword
			#,(SUM(IF(Status = 'Hit',1,0)) + SUM(IF(Status = 'NotFound',1,0))) AS total_searches	
			, Status
			, SUM( IF(Status = 'Hit',1,0)) AS status_count
			, SUM(IF(s.Status = 'NotFound',1,0)) AS sum_notfound
	FROM search s

#Where # Limiting results to Link only for now 
#	  s.SessionId = 'cc849a928f720eda3115bf33aed908c1' 	
#	  and s.Keyword = 'stop blocks'

	GROUP BY SessionId, s.Keyword, Status;




	SELECT SessionId, Page_URL, Tab_Name, Series_Code, 
		   COUNT(DISTINCT Tab_Name) AS Tab_name_count,
		   COUNT(*) AS Link_count 
				FROM detail_tab d
WHERE d.Tab_Name = '4' AND 
	  # Limiting results to Link only for now 
	  d.SessionId = 'cc849a928f720eda3115bf33aed908c1' 	

	GROUP BY SessionId, Series_Code, Tab_Name;





SELECT
  t.Topic,
  t.Title,
  s.StarCount,
  m.UserCount,
  m.MessageCount
FROM
  Topics t
  LEFT JOIN (
    SELECT 
      Topic, 
      COUNT(DISTINCT User) AS UserCount,
      COUNT(*) AS MessageCount
    FROM Messages
    GROUP BY Topic
  ) m ON m.Topic = t.Topic
  LEFT JOIN (
    SELECT
      Topic, 
      COUNT(*) AS StarCount
    FROM Stars_Given 
    GROUP BY Topic
  ) s ON s.Topic = t.Topic;



SELECT SessionId, Page_URL, Tab_Name, Series_Code, COUNT(DISTINCT Tab_Name) AS Tab_name_count
				FROM detail_tab
				WHERE Tab_Name = '4' AND SessionId = 'cc849a928f720eda3115bf33aed908c1' 	

	GROUP BY SessionId, Tab_Name;

