ALTER FUNCTION GetStdDev 
    (
      @TKR  VARCHAR(10)
    )
RETURNS TABLE
AS
    RETURN
    (
        SELECT x.[date], ISNULL(STDEV(y.[Close]),0) stdev
        FROM Tickers x, Tickers y
        WHERE x.[DATE] > (SELECT TOP 1 z.[DATE] FROM TICKERS z WHERE z.TICKER = @TKR ORDER BY z.DATE ASC)+20
        AND (DATEDIFF(day, x.[date], GETDATE()) <= 730) 
        AND x.TICKER = @TKR AND y.TICKER = @TKR
        AND x.[DATE] BETWEEN y.[DATE]-20 AND y.[DATE]
        GROUP BY x.DATE
    )

