SELECT  s.CompanyID, 
        s.ShareDate, 
        s.OutstandingShares, 
        s.ControlBlock 
FROM (
    SELECT MAX(ShareDate) AS Sharedate, 
           CompanyID
    FROM ShareInfo
    WHERE (ShareDate <= @filter_date)
    GROUP BY CompanyID
 ) AS si 
 INNER JOIN
 tblShareInfo AS s ON s.ShareDate = si.Sharedate AND s.CompanyID = si.CompanyID

From a _
In db_context.ShareInfos _
Where a.ShareDate <= filter_date _
Group a By a.CompanyID Into Group _
Select CompanyID, MostRecentShareDate = Group.Max(Function(a) a.ShareDate) _
Join b In db_context.ShareInfos On b.CompanyID Equals a.CompanyID _
Select b.CompanyID, b.ShareDate, b.OS, b.CB()

