SELECT node.name, (COUNT(parent.name) - (sub_tree.depth + 1)) AS depth
FROM line_items AS node,
    line_items AS parent,
    line_items AS sub_parent,
    (SELECT node.name, (COUNT(parent.name) - 1) AS depth
        FROM line_items AS node,
        line_items AS parent
        WHERE node.lft BETWEEN parent.lft AND parent.rgt
        AND node.name = 'Power Up'
        GROUP BY node.name
        ORDER BY node.lft
    ) AS sub_tree
WHERE node.lft BETWEEN parent.lft AND parent.rgt
    AND node.lft BETWEEN sub_parent.lft AND sub_parent.rgt
    AND sub_parent.name = sub_tree.name
GROUP BY node.name
HAVING depth <= 1
ORDER BY node.lft;

sub_tree.name
