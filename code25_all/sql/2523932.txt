SELECT DISTINCT 
   UserName AS UserName, 
   MAX(AmountUsed) AS AmountUsed, 
   MAX(AnsweredCorrectly) AS AnsweredCorrectly, 
   CourseName, 
   MAX(course_code) AS course_code, 
   MAX(NoOfQuestionsInCourse) AS NoOfQuestionsInCourse, 
   MAX(NoOfQuestionSetsInCourse) AS NoOfQuestionSetsInCourse
FROM 
   ( "SELECT statement 1"  UNION  "SELECT statement 2" ) dt_derivedTable_1 
GROUP BY CourseName, UserName

--  SELECT DISTINCT MAX(UserName), MAX(AmountUsed) AS AmountUsed, MAX(AnsweredCorrectly) AS AnsweredCorrectly, CourseName, MAX(course_code) AS course_code, MAX(NoOfQuestionsInCourse) AS NoOfQuestionsInCourse, MAX(NoOfQuestionSetsInCourse) AS NoOfQuestionSetsInCourse
--  FROM (

                SELECT DISTINCT UserName AS UserName, MAX(AmountUsed) AS AmountUsed, MAX(AnsweredCorrectly) AS AnsweredCorrectly, CourseName, MAX(course_code) AS course_code, MAX(NoOfQuestionsInCourse) AS NoOfQuestionsInCourse, MAX(NoOfQuestionSetsInCourse) AS NoOfQuestionSetsInCourse
                FROM (

                        -- Table 1 - All UserAccount/Course combinations that have had quizzez.
                        SELECT DISTINCT dbo.win_user.user_name AS UserName, 
                                        cast(dbo.GetAmountUsed(dbo.session_header.win_user_id, dbo.course.course_id, dbo.course.no_of_questionsets_in_course) as nvarchar(10)) AS AmountUsed, 
                                        Isnull(cast(dbo.GetAnswerCorrectly(dbo.session_header.win_user_id, dbo.course.course_id, dbo.question_set.no_of_questions) as nvarchar(10)),0) AS AnsweredCorrectly, 
                                        dbo.course.course_name AS CourseName, 
                                        dbo.course.course_code,
                                        dbo.course.no_of_questions_in_course AS NoOfQuestionsInCourse, 
                                        dbo.course.no_of_questionsets_in_course AS NoOfQuestionSetsInCourse
                        FROM            dbo.session_detail 
                                        INNER JOIN dbo.session_header ON dbo.session_detail.session_header_id = dbo.session_header.session_header_id
                                        INNER JOIN dbo.win_user ON dbo.session_header.win_user_id = dbo.win_user.win_user_id
                                        INNER JOIN dbo.win_user_course ON dbo.win_user_course.win_user_id = dbo.win_user.win_user_id
                                        INNER JOIN dbo.question_set ON dbo.session_header.question_set_id = dbo.question_set.question_set_id
                                        RIGHT OUTER JOIN dbo.course ON dbo.win_user_course.course_id = dbo.course.course_id
                        WHERE           (dbo.session_detail.no_of_attempts = 1 OR dbo.session_detail.no_of_attempts IS NULL)
                                        AND (dbo.session_detail.is_correct = 1 OR dbo.session_detail.is_correct IS NULL)
                                        AND (dbo.win_user_course.is_active = 'True')
                        GROUP BY        dbo.win_user.user_name, dbo.course.course_name, dbo.question_set.no_of_questions, dbo.course.no_of_questions_in_course, 
                                        dbo.course.no_of_questionsets_in_course, dbo.session_header.win_user_id, dbo.course.course_id, dbo.course.course_code

                    UNION ALL

                        -- Table 2 - All UserAccount/Course combinations that do or do not have quizzes but where the Course is selected for quizzes for that User Account.
                        SELECT          dbo.win_user.user_name AS UserName, 
                                        -1 AS AmountUsed, 
                                        -1 AS AnsweredCorrectly, 
                                        dbo.course.course_name AS CourseName, 
                                        dbo.course.course_code,
                                        dbo.course.no_of_questions_in_course AS NoOfQuestionsInCourse, 
                                        dbo.course.no_of_questionsets_in_course AS NoOfQuestionSetsInCourse
                        FROM            dbo.win_user_course
                                        INNER JOIN dbo.win_user ON dbo.win_user_course.win_user_id = dbo.win_user.win_user_id
                                        RIGHT OUTER JOIN dbo.course ON dbo.win_user_course.course_id = dbo.course.course_id
                        WHERE           (dbo.win_user_course.is_active = 'True')
                        GROUP BY        dbo.win_user.user_name, dbo.course.course_name, dbo.course.no_of_questions_in_course, 
                                        dbo.course.no_of_questionsets_in_course, dbo.course.course_id, dbo.course.course_code

                ) dt_derivedTable_1 

                GROUP BY CourseName, UserName

--      UNION ALL

            -- Table 3 - All Courses.
--          SELECT DISTINCT null AS UserName,
--                          -2 AS AmountUsed, 
--                          -2 AS AnsweredCorrectly, 
--                          dbo.course.course_name AS CourseName,
--                          dbo.course.course_code,
--                          dbo.course.no_of_questions_in_course AS NoOfQuestionsInCourse, 
--                          dbo.course.no_of_questionsets_in_course AS NoOfQuestionSetsInCourse
--          FROM            dbo.course
--          WHERE           is_active = 'True'


--  ) dt_derivedTable_2 

--  GROUP BY CourseName
--  ORDER BY CourseName

