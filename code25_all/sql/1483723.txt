SELECT PERSONID, 
       CARDEVENTDATE, 
       INTIME, 
       CASE 
         WHEN OUTTIME = INTIME THEN 
           'No PunchOut' 
         ELSE 
            OUTTIME 
       END AS OUTTIME, 
       CONVERT(char(8), CASE 
                          WHEN DateAdd(Day, - DateDiff(Day, 0, OutTime), OutTime) > '18:00:00' THEN 
                            Cast('18:00:00' AS datetime) 
                          ELSE 
                            DateAdd(Day, - DateDiff(Day, 0, OutTime), OutTime) 
                        END - CASE 
                                WHEN DateAdd(Day, - DateDiff(Day, 0, InTime), InTime) < '09:00:00' THEN 
                                  Cast('09:00:00' AS datetime) 
                                ELSE 
                                  DateAdd(Day, - DateDiff(Day, 0, InTime), InTime) 
                              END, 8) AS WorkTime
  FROM (SELECT T_PERSON.PERSONID,
               T_CARDEVENT.CARDEVENTDATE, 
               MIN(T_CARDEVENT.CARDEVENTTIME) AS INTIME, 
               MAX(T_CARDEVENT.CARDEVENTTIME) AS OUTTIME
          FROM T_PERSON 
    INNER JOIN T_CARDEVENT ON T_PERSON.PERSONID = T_CARDEVENT.PERSONID 
      GROUP BY T_PERSON.PERSONID, T_CARDEVENT.CARDEVENTDATE) DERIVEDTBL

