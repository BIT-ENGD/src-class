PatientId   Admitted
---------   ---------------
1       d/m/yy hh:mm:ss
2       d/m/yy hh:mm:ss
3       d/m/yy hh:mm:ss

PatientId   MeasurementId   Recorded        Value
---------   -------------   ---------------     -----
1       A       d/h/yy hh:mm:ss     100
1       A       d/h/yy hh:mm:ss     200
1       A       d/h/yy hh:mm:ss     300
2       A       d/h/yy hh:mm:ss     10
2       A       d/h/yy hh:mm:ss     20
1       B       d/h/yy hh:mm:ss     1
1       B       d/h/yy hh:mm:ss     2

PatientId   Numerator   Denominator
---------   --------    -----------
1       1       1
2       1       1
3       0       1       

SELECT  PatientId, CASE WHEN a.cnt+b.cnt>2 THEN 1 ELSE 0 END Numerator, 1 Denominator
FROM    patient p

LEFT OUTER JOIN (
    SELECT  PatientId, count(*) cnt
    FROM    PatientMeasurement pm
    WHERE   MeasurementId='A'
    --AND   Recorded <= dateadd(hh, 12, Admitted)
    GROUP BY PatientId
) a ON p.PatientId=a.PatientId

LEFT OUTER JOIN (
    SELECT  PatientId, count(*) cnt
    FROM    PatientMeasurement pm
    WHERE   MeasurementId='B'
    --AND   Recorded <= dateadd(hh, 12, Admitted)
    GROUP BY PatientId
) b ON p.PatientId=b.PatientId

SELECT  PatientId, CASE WHEN v.a+v.b>2 THEN 1 ELSE 0 END Numerator, 1 Denominator
FROM    (

    SELECT  PatientId,
    (
        SELECT  PatientId, count(*) cnt
        FROM    PatientMeasurement pm
        WHERE   PatientId=p.PatientId
        AND MeasurementId='A'
        AND Recorded <= dateadd(hh, 12, Admitted)
        GROUP BY PatientId
    ) a,
    (
        SELECT  PatientId, count(*) cnt
        FROM    PatientMeasurement pm
        WHERE   PatientId=p.PatientId
        AND MeasurementId='B'
        AND Recorded <= dateadd(hh, 12, Admitted)
        GROUP BY PatientId
    ) b
    FROM    Patient p
) v

