declare @name varchar(50)
declare @city varchar(50)
declare @grouplist varchar(50)

set @name = null
set @city = null
set @grouplist = null

select distinct
p.PersonID,
p.PersonName,
c.City
from
tblPerson p left join tblCities c on p.PersonID = c.PersonID
join
    (
       select m.PersonID
       from tblGroupMembership m
       where (m.GroupID in (select item from fnSplit(@grouplist, ',')))
       group by m.PersonID
       having (count(*) = (select count(*) from fnSplit(@grouplist, ',')))
    ) as filter
    on (@grouplist is not null) and (p.PersonID = filter.PersonID)
where
((@name is null) or (p.PersonName like '%' + @name + '%')) and
((@city is null) or (c.City like '%' + @city + '%'))

