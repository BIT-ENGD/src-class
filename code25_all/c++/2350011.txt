#include <tchar.h>
#include <windows.h>
#include <mapi.h>
#include <mapix.h>

int _tmain( int argc, wchar_t *argv[] )
{
    HMODULE hMapiModule = LoadLibrary( _T( "mapi32.dll" ) );

    if ( hMapiModule != NULL )
    {
        LPMAPIINITIALIZE lpfnMAPIInitialize = NULL;
        LPMAPIUNINITIALIZE lpfnMAPIUninitialize = NULL;
        LPMAPILOGONEX lpfnMAPILogonEx = NULL;
        LPMAPISENDDOCUMENTS lpfnMAPISendDocuments = NULL;
        LPMAPISESSION lplhSession = NULL;
        LPMAPISENDMAIL lpfnMAPISendMail = NULL;

        lpfnMAPIInitialize = (LPMAPIINITIALIZE)GetProcAddress( hMapiModule, "MAPIInitialize" );
        lpfnMAPIUninitialize = (LPMAPIUNINITIALIZE)GetProcAddress( hMapiModule, "MAPIUninitialize" );
        lpfnMAPILogonEx = (LPMAPILOGONEX)GetProcAddress( hMapiModule, "MAPILogonEx" );
        lpfnMAPISendDocuments = (LPMAPISENDDOCUMENTS)GetProcAddress( hMapiModule, "MAPISendDocuments" );
        lpfnMAPISendMail =      (LPMAPISENDMAIL)GetProcAddress( hMapiModule, "MAPISendMail" );

        if ( lpfnMAPIInitialize && lpfnMAPIUninitialize && lpfnMAPILogonEx && lpfnMAPISendDocuments )
        {
            HRESULT hr = (*lpfnMAPIInitialize)( NULL );

            if ( SUCCEEDED( hr ) )
            {
                hr = (*lpfnMAPILogonEx)( 0, NULL, NULL, MAPI_EXTENDED | MAPI_USE_DEFAULT, &lplhSession );

                if ( SUCCEEDED( hr ) )
                {
                    // this opens the email client 
                    // create the msg.  We need to add recipients AND subject AND the dmp file              

                    // file attachment
                    MapiFileDesc filedesc;              
                    ::ZeroMemory(&filedesc, sizeof(filedesc));                  
                    filedesc.nPosition = (ULONG)-1;
                    filedesc.lpszPathName = "E:\\Development\\Open\\testmail\\testmail.cpp";    

                    // recipient(s)
                    MapiRecipDesc recip;
                    ::ZeroMemory(&recip, sizeof(recip));        
                    recip.lpszName = "QA email";
                    recip.lpszAddress = "qa@myaccount.com";

                    // the message
                    MapiMessage msg;
                    ::ZeroMemory(&msg, sizeof(msg));
                    msg.lpszSubject     = "Test";   
                    msg.nRecipCount     = 1; // if I comment out this line it works fine...                 
                    msg.lpRecips        = &recip;                                       
                    msg.nFileCount      = 1;
                    msg.lpFiles         = &filedesc;                

                    hr = (*lpfnMAPISendMail)(0, NULL, &msg, MAPI_LOGON_UI|MAPI_DIALOG, 0);

                    if ( SUCCEEDED( hr ) )
                    {
                        hr = lplhSession->Logoff( 0, 0, 0 );
                        hr = lplhSession->Release();
                        lplhSession = NULL;
                    }
                }
            }

            (*lpfnMAPIUninitialize)();
        }

        FreeLibrary( hMapiModule );
    }

    return 0;
}

