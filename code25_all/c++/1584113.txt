case WM_PAINT:
    hdc = BeginPaint(hWnd, &ps);
    GdiplusStartup(&gdiplusToken, &gdiPlusStartup, 0);
    DrawM(ps.hdc, hWnd);
    EndPaint(hWnd, &ps);
    break;

void DrawMap(HDC hdc, HWND hWnd)
{

if(!isDrawn)
{
            // (some calculations)
    Graphics g(hdc);
    Bitmap img(max_x, max_y, &g);

    int zoom_factor = 50;
    for(int i = 0; i< segments.size(); i++)
    {
                   // (some math)
        for(int j = 0; j < segments.at(i).point_count; j++)
                // (another dose of math)
        g.DrawLines(&pen, segmentPoints, segments.at(i).point_count);
        delete [] segmentPoints;
    }
    g.Save();
    isDrawn = true;
}
else
{ 
        // here is the problem
} 

    CLSID pngClsid;
    GetEncoderClsid(L"image/png", &pngClsid);
    img.Save(_T("m.png"), &Gdiplus::ImageFormatPNG, NULL);

    Graphics g(hdc);
    g.DrawImage(bmpClone, 50, 50);

