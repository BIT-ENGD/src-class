typedef BOOL  (CALLBACK* LPFNDLLLOAD)();
typedef BOOL  (CALLBACK* LPFNDLLRUN)(HINSTANCE, HWND, LPBYTE *, LONG *);

BOOL CTesteExeDlg::OnInitDialog()
{
    CDialog::OnInitDialog();

    // Set the icon for this dialog.  The framework does this automatically
    //  when the application's main window is not a dialog
    SetIcon(m_hIcon, TRUE);         // Set big icon
    SetIcon(m_hIcon, FALSE);        // Set small icon

    //CModule mod;
    //mod.Create(L"\\Program Files\\PMA\\Teste.dll");
    //mod.Run(AfxGetInstanceHandle(), GetSafeHwnd(), 0, 0);

    HMODULE m_hModule = AfxLoadLibrary(L"\\Program Files\\PMA\\TesteDll.dll");
    LPFNDLLLOAD m_lpfnLoad= (LPFNDLLLOAD)GetProcAddress(m_hModule, _T("_Load"));
    LPFNDLLRUN  m_lpfnRun = (LPFNDLLRUN)GetProcAddress(m_hModule, _T("_Run"));

    m_lpfnLoad();
    m_lpfnRun(AfxGetInstanceHandle(), GetSafeHwnd(), 0, 0);

    return TRUE;  // return TRUE  unless you set the focus to a control
}

#include "stdafx.h"
#include "TesteDll.h"
#include "TesteDllDlg.h"

#ifdef _DEBUG
#define new DEBUG_NEW
#endif

extern "C" BOOL PASCAL EXPORT _Load()
{
    AFX_MANAGE_STATE(AfxGetStaticModuleState());
    return TRUE;
}

extern "C" BOOL PASCAL EXPORT _Unload()
{
    AFX_MANAGE_STATE(AfxGetStaticModuleState());

    return TRUE;
}

extern "C" BOOL WINAPI EXPORT _Run(HINSTANCE hInst,
                                   HWND hwndParent,
                                   LPBYTE *buffer,
                                   LONG *size)
{
    AFX_MANAGE_STATE(AfxGetStaticModuleState());

    CTesteDllDlg d;
    d.DoModal(); ////-------------> Error Here

    return FALSE;
}

BOOL CTesteDllDlg::OnInitDialog()
{
    CDialog::OnInitDialog();

    AfxMessageBox(L"Oi");

    return TRUE;  // return TRUE unless you set the focus to a control
    // EXCEPTION: OCX Property Pages should return FALSE
}

LIBRARY      "TesteDll"

EXPORTS
    ; Explicit exports can go here
    _Load           @1
    _Unload         @2
    _Run            @3

