// Note all error handling removed for readability :)
STDMETHODIMP CPlugin::get_HTML(long lMaxSize, BSTR *pbstrHTML)
{
    CComPtr<IDispatch> pDispatch;
    MSHTML::IHTMLDocument2Ptr pDocument2 = NULL;
    MSHTML::IHTMLDocument3Ptr pDocument3 = NULL;
    hr = m_spWebBrowser->get_Document(&pDispatch);
    hr = pDispatch->QueryInterface(IID_IHTMLDocument3, (void**)&pDocument3);
    MSHTML::IHTMLElementPtr pRoot = pDocument3->documentElement;
    wstring strHTML = pRoot->outerHTML;
    CComBSTR bstrHTML = strOutput.c_str();
    bstrHTML.CopyTo(pbstrHTML);
}

