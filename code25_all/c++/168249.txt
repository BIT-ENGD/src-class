handleRequest(string key)
handleRequest
key
handleRequest(key)
key
handleRequest
void handleRequest(string key) {
    KeyLock lock(key);
    // Handle the request.
}

KeyLock
KeyLock::KeyLock(string key) {
    global_lock->Lock();
    internal_lock_ = global_key_map[key];
    if (internal_lock_  == NULL) {
        internal_lock_  = new Lock();
        global_key_map[key] = internal_lock_;
    }
    global_lock->Unlock();
    internal_lock_->Lock();
}

KeyLock::~KeyLock() {
    internal_lock_->Unlock();
    // Remove internal_lock_ from global_key_map iff no other threads are waiting for it.
}

Lock
handleRequest
