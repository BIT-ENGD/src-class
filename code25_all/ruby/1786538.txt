Chat:
  has_many :messages

Message:
  belongs_to :chat, :counter_cache => true
  belongs_to :authorable, :polymorphic => true

User:
  has_many :messages, :as => :authorable
  has_many :chats, :through => :messages, :uniq => true

Guest:
  has_many :messages, :as => :authorable

