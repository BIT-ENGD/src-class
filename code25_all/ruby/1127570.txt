def test_authentication
  #check we can log in
  post :login, :user => { :username => "bob", :password => "test" }
  assert_not_nil session[:user_id]
  assert_equal users(:bob).id, session[:user_id]
  assert_response :redirect
  assert_redirected_to :action => 'welcome'
end

def login
  if request.post?
    if session[:user_id] = User.authenticate(params[:user][:username], params[:user][:password])
    flash[:message] = "Login succeeded!"
    redirect_to_stored
    else
      flash[:warning] = "Login failed."
    end
  end
end

def test_registration
  #check that we can register and are logged in automatically
  post :register, :user => { :username => "newuser", :password => "pass", :password_confirmation => "pass", :email => "newuser@web.com" }
  assert_response :redirect
  assert_not_nil session[:user_id]
  assert_redirected_to :action => 'welcome'
end

def register
  @user = User.new(params[:user])
  if request.post?
    if @user.save
      session[:user_id] = User.authenticate(@user.username, @user.password)
      flash[:message] = "Registration succeeded"
      redirect_to :action => 'welcome'
    end
  else
    flash[:warning] = "Registration failed"
  end
end

bob:
  username: bob
  email: bob@mcbob.com 
  hashed_password: 77a0d943cdbace52716a9ef9fae12e45e2788d39 # test
  salt: 1000

