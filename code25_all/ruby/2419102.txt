  def test_new_should_save_purchase_if_not_free       
    user = users(:some)
    purchase = user.purchases.build 
    @controller.stubs(:current_user).returns(user)
    purchases_mock = mock
    user.stubs(:purchases).returns(purchases_mock)
    purchases_mock.stubs(:build).returns(purchase)
    purchase.expects(:save).returns(true)
    get :new, :item_id => items(:not_free).id, :quantity => 10
    get :new, :item_id => items(:free).id, :quantity => 400
  end

  def new                                                         
    @purchase.quantity = params[:quantity]
    @purchase.item = Item.find(params[:item_id])
    unless @purchase.item.free?
      @purchase.save
    end
  end

  def find_or_initialize
    @purchase = params[:id] ? current_user.purchases.find(params[:id]) : current_user.purchases.build
  end   

