<html><body>
  <div box>
    some text
    <div box>
      some more text
    </div>
  </div>
  <div box>
    this needs to be included as well
  </div>
</body></html>

<div box>
<div box>
<div box>
//[@box and not(ancestor::@box)
# Assuming html is set to the html above
doc = Hpricot(html)
elements = doc.search('//[@box and not(ancestor::@box)]')

# The following is returning 3 instead of 2
elements.size

