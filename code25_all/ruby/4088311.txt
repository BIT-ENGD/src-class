class Deal
  belongs_to :market
  belongs_to :merchant
end

class Market
  has_many :deals
  has_many :merchants
end

class Merchant
  has_many :deals
  belongs_to :market
  belongs_to :business_type
end

class BusinessType
  has_many :merchants
  has_many :deals, :through => :merchants
end

class BusinessType
  def revenue(market=nil)
    if market.nil?
      return self.deals.sum('price')
    else
      return self.deals(:conditions => ['market_id = ?',market]).sum('price')
    end
  end
end

puts BusinessType.first.revenue

puts BusinessType.first.revenue(1)

puts BusinessType.first.revenue(market=1)

