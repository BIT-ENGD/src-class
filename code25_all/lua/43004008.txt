body_filter_by_lua
ngx.header.content_length = nil

Transfer-Encoding: chunked
ngx.header['Content-Type'] = "text/html"
ngx.header['Content-Length'] = nil
ngx.header['Transfer-Encoding'] = 'chunked'

-- Length of current chunk.
local hexlen = string.format("%x", #ngx.arg[1])
ngx.arg[1] = hexlen .. "\r\n" .. ngx.arg[1] .. "\r\n"

-- Last chunk. Send final sequence.
if (ngx.arg[2]) then
    ngx.arg[1] = ngx.arg[1] .. "0\r\n\r\n"
end

ngx.location.capture
