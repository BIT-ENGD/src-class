function handler(c, host, port)
    local peer = host .. ":" .. port
    print("connection from ", peer)
    while 1 do
        command = c:receive"*l"
        c:send(router(command))
    end
end


copas.addserver(assert(socket.bind("127.0.0.1", 8888)),
                        function(c) return handler(copas.wrap(c), c:getpeername()) end
)


copas.loop()

