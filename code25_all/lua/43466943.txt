socket = require 'socket'
server = assert(socket.bind("*", 9000))

function read(client, pattern, prefix)
  local data, emsg, partial = client:receive(pattern, prefix)
  if data then
    return data
  end
  if partial and #partial > 0 then
    return partial
  end
  return nil, emsg
end

while true do
  local client = server:accept()
  client:settimeout(3)
  local msg, err = read(client, '*a')

  if not err then
    print(msg)
    client:close()
  end
end

print(msg)
{
