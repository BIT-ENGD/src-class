curl -i -X GET http://localhost/widgets/widget?name=testname&loc=20000 -H "Accept:application/json"

server {
    listen       80;
    server_name  nsps2;
root    /var/www/;
index   index.html index.htm;
#charset koi8-r;

#access_log  logs/host.access.log  main;
#curl http://localhost/hello?name=johndoe
location /hello {
        default_type "text/plain";
        content_by_lua '
        local rquri = ngx.var.request_uri;
        ngx.say("the uri is ", rquri ,".")

        local name = ngx.var.arg_name or "Anonymous"
                ngx.say("Hello, ", name, "!")
                ';
}

location / {
    root   /var/www/;
    index  index.html index.htm;
}

#curl -i -X GET http://localhost/widgets/widget?name=testname&loc=20000 -H "Accept:application/json"
location /widgets/widget {
        root /var/www/widgets;          
        default_type "text/pain";
        content_by_lua '
        local arga,argb = ngx.arg[1], ngx.arg[2] ;
        ngx.say("the arga is ", arga ,".")
        ngx.say("the argb is ", argb, ".")
        ';
}

2015/02/24 20:18:19 [error] 2354#0: *1 lua entry thread aborted: runtime error: content_by_lua:2: API disabled in the context of content_by_lua*
stack traceback:
coroutine 0:
    [C]: in function '__index'
    content_by_lua:2: in function <content_by_lua:1>, client: 127.0.0.1, server: nsps2, request: "GET /widgets/widget?name=testname?loc=20000 HTTP/1.1", host: "localhost"

    location /widgets/widget {
            default_type "text/pain";
            content_by_lua '
        local args = ngx.req.get_uri_args()
        for key, val in pairs(args) do
            if type(val) == "table" then
                ngx.say(key, ": ", table.concat(val, ", "))                    
            else
                ngx.say(key, ": ", val)
            end
        end
            ';
    }

 mytestdevbox2:/var/www/nsps2# curl -i -X GET http://localhost/widgets/widget?name=testname&loc=20000 -H "Accept:application/json"
-ash: -H: not found
mytestdevbox2:/var/www/nsps2# HTTP/1.1 200 OK
Server: nginx/1.6.2
Date: Tue, 24 Feb 2015 21:32:44 GMT
Content-Type: text/pain
Transfer-Encoding: chunked
Connection: keep-alive

name: testname

[1]+  Done                       curl -i -X GET http://localhost/widgets/widget?name=testname

mytestdevbox2:/var/www/nsps2# curl -i -X GET 'http://localhost/widgets/widget?name=testname&loc=20000'
HTTP/1.1 200 OK
Server: nginx/1.6.2
Date: Wed, 25 Feb 2015 12:59:29 GMT
Content-Type: text/pain
Transfer-Encoding: chunked
Connection: keep-alive

loc: 20000
name: testname
mytestdevbox2:/var/www/nsps2# 

