core.register_service("chooseserver", "tcp", function(AppletTCP)
  function string.checkit(str)
      --mylogichere
      return string.char('server1')
  end

  tcp_line = AppletTCP:getline()
  server = tcp_line:checkit()
  if server == 'server1'   then
    -- HERE
    AppletTCP:send(tcp_line)
  else
    AppletTCP:send(tcp_line)
  end
end)

listen proxy
   bind 127.0.0.1:10001
   tcp-request content use-service lua.chooseserver

