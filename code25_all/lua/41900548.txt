JSON = require("JSON")

local function point_parse(rec)
   local ret = map()
   local s = tostring(rec["geog"]) --rec["geogStr"] 
    --hack: i want the value of the bin which is geojson of type userdata.
    --if i tostring it, it adds extra quotes around the string which breaks the parser e.g. "'JSON'" instead of 'JSON'
    --im sure there is a simple solution but i dont know enough about aerospike or lua yet
   s = string.sub(s,2,-2)
   --example s = '{"type": "Point", "coordinates": [-0.19546933518948587, 51.59832901311651]}'
   local parsed = JSON:decode(s)["coordinates"]
   ret["x"] = parsed[1]
   ret["y"] = parsed[2] 
   return ret
end

function relay_point(stream)
    return stream : map(point_parse);
end

