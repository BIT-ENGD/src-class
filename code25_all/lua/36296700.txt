filename = "file10KB.txt"
file = assert(io.open(filename, "r"))
msg = file:read("*a")
file:close()

socket = require("socket")

host = "*"
port =  8080

print("Binding to host '" .. host .. "' and port " .. port .. "...")

server = assert(socket.bind(host, port))
server:setoption("reuseaddr", true)
ipaddress, socketport = server:getsockname()
assert(ipaddress, socketport)

print("Waiting connection from client on " .. ipaddress .. ":" .. socketport .. "...")

connection = assert(server:accept())
connection:setoption("keepalive", true)
connection:settimeout(10)

print("Connected!")

while true do
    print("Waiting for request...")
    data, errormsg = connection:receive()

    if data == "arquivo" then
        print("Proper request received, sending message...")
        assert(connection:send(msg .. "\n"))
        print("Message sent!")
    elseif not errormsg then
        print("Invalid request.")
        break
    else
        print("Error message: " .. errormsg)
        break
    end
end

socket = require("socket")

host = "localhost"
port = 8080

print("Attempting connection to server '" .. host .. "' and port " .. port .. "...")

client = assert(socket.connect(host, port))

client:setoption("keepalive", true)
client:setoption("reuseaddr", true)
client:settimeout(10)

print("Connected!")

repeat
    print("Sending message request...")
    assert(client:send("arquivo" .. "\n"))

    print("Message request sent! Waiting for message...")
    data, errormsg = client:receive("*a")

    if data then
        print("Message received!")
        print(data)
    else
        print("Failed to receive message.")
        break
    end
until not client

