S3
S3
nginx.conf
location ~ "^/media/(.*?)/(.*?)/(.*)$" {
     set $mediaUrl "$1/$2/$3";
     set $key "$2/$3"
     set $target http://$1.s3.amazonaws.com

     rewrite_by_lua "
         local uri = '/authenticate'
         local res = ngx.location.capture(uri, {args = { param = '/xmedia/'.. ngx.var.mediaUrl }})

         if (res.status ~= 200) then
              return ngx.exit(ngx.HTTP_GONE)
              end
         ";

         rewrite .* /$key break;
         proxy_pass $target;
}

location "/authenticate" {
    proxy_set_header Range "";
    proxy_set_header Content-Range "";
    set_by_lua $param "
        local params = ngx.req.get_uri_args()
        return params.param
    ";

    set $test_url http://127.0.0.1:some_port/authenticate?url=$param;
    proxy_pass $test_url;
 }

null
if
return ngx.exit(ngx.HTTP_GONE)
