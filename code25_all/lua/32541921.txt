#!/usr/bin/env lua

local socket = require("socket")
local server = assert(socket.bind("*", 0))
local ip, port = server:getsockname()

local data = {}
local count = 1
local function pollSensors()
  -- I do the sensor polling here and add to table e.g os.time()
  table.insert(data, os.time() .."\t" .. tostring(count))
  count = count + 1
end

while true do
  local client = server:accept()
  client:settimeout(2)
  local line, err = client:receive()
  -- I do process the received line to determine the response
  -- for illustration I'll just send the number of items in the table
  if not err then client:send("Records: " ..table.getn(data) .. "\n") end
  client:close()
  if os.time().sec == 59 then
     pollSensors()
  end
end

