get
set
copas.wrap()
receive
local copas  = require "copas"
local socket = require "socket"

local function iterate (x)
  local client = socket.tcp ()
  client:connect("127.0.0.1", 6379)
  client:settimeout (0)
  client = copas.wrap (client)
  return coroutine.wrap (function ()
    for k, v in pairs (x) do
      client:receive "*l"
      coroutine.yield (k, v)
    end
    client:close ()
  end)
end

local data = {}
for i = 1, 2 do
  data [i] = i
end

local function worker ()
  local id = coroutine.running ()
  for k, v in iterate (data) do
    print (id, k, v)
  end
end

copas.addthread (worker)
copas.addthread (worker)

copas.loop ()

thread: 0x1b31990   tcp{client}: 0x1b31e48  table: 0x1b2eac0
thread: 0x1b31990   tcp{client}: 0x1b31e48  table: 0x1b2eac0
...

client:settimeout (0)
client:receive
