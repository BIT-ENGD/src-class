location = "/test" {
  proxy_pass http://localhost$is_args$args;
  access_by_lua_file ./header.lua; 
}

  local cjson = require "cjson"

  res = ngx.location.capture(
    '/get_token',
    { method = ngx.HTTP_GET, args = { id: 1234 } }
  );

  if res.status == ngx.HTTP_OK then
    body = cjson.decode(res.body)
    local token = body["token"]
    ngx.log(ngx.ERR, token)
    ngx.headers["Token"] = token
  else
    ngx.say("Failed to retrieve token")
    ngx.exit(401);
  end

ngx.headers
ngx.req.set_headers()
