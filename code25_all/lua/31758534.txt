/usr/bin/ssh admin@server.domain.com "lua/rpi.init" 
lua: lua/rpi.init:8: attempt to index upvalue 'logFile' (a nil value) stack traceback:
        lua/rpi.init:8: in function 'logMsg'
        lua/rpi.init:47: in main chunk

#!/usr/bin/env lua
local f = assert(io.popen("sudo netstat -a | grep ^tcp[^6] | grep LISTEN | grep [^0-9]22[0-9][0-9]", 'r'))
local ports22 = {}
local logFile

function logMsg(msg)
        logFile = io.open("logs/pi.init.log", "a+")
        logFile:write(os.date("%b %d %Y %X ") .. tostring(msg) .. "\n")
        logFile:close()
end

function getPorts22()
logMsg("Getting available ports...")
while true do
        line = f:read()
        if line == nil then break end
        port = string.sub(line, 40, 44)
        table.insert(ports22, port)
end
f:close()
table.sort(ports22)
end

function getNextOpenPort22()
        local openPort = 2222
        if #ports22 == 0 then
                logMsg("Returning port :" .. openPort)
                return openPort
        end
        for i=1, #ports22 + 1 do
                if tonumber(ports22[i]) == openPort then
                        openPort = openPort + 1
                else
                        logMsg("Returning port: " .. openPort)
                        return openPort
                end
        end

end


function printPorts()
        msg = table.concat(ports22, ", ")
        logMsg("Found ports in use: " .. tostring(msg))
end

logMsg("Script called to run.")
getPorts22()
printPorts()
print(getNextOpenPort22())

