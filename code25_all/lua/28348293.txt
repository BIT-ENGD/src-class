SELECT item, sum(qty), sum(price), sum(discount)
FROM items
WHERE timestamp between 20150101000000 and 20150101235959 GROUP BY item

local function aggregate_item_stats(itemMap,rec)
  local item = rec.item
  local innerMap = itemMap[item]
  if innerMap == nil then
        innerMap = {qty = 0, price = 0, discount = 0}
  end
  innerMap.qty = innerMap.qty + (tonumber(rec.qty) or 0);
  innerMap.price = innerMap.price + (tonumber(rec.price) or 0);
  innerMap.discount = innerMap.discount + (tonumber(rec.discount) or 0);
  itemMap[item] = innerMap  
  return itemMap
end

local function fn_merge(a,b)
  a.qty = a.qty + b.qty
  a.price = a.price + b.price
  a.discount = a.discount + b.discount
  return a
end
local function reduce_values(a, b)
  return map.merge(a, b, fn_merge)
end
function highUsageReport(stream)
 return stream : aggregate(itemMap{}, aggregate_item_stats) : reduce(reduce_values)
end

