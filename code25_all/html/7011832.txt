<script language="JavaScript" type="text/javascript">
    var sendReq = getXmlHttpRequestObject();
    var receiveReq = getXmlHttpRequestObject();
    var lastMessage = 0;
    var mTimer;
    function handleReceiveChat() 
    {
       if (receiveReq.readyState == 4)
       {
          var chat_div = document.getElementById('div_chat');    
          var xmldoc = receiveReq.responseXML;     
          var message_nodes = xmldoc.getElementsByTagName("message");
          //more code
       }
    }


    function getChatText()
    {
        if (receiveReq.readyState == 4 || receiveReq.readyState == 0) 
        {
           receiveReq.open("GET", 'getChat_xml.php?chat=1&last=' + lastMessage, true);
           receiveReq.onreadystatechange = handleReceiveChat; 
           receiveReq.send(null);
        }
    }
</script>

$xml = '<?xml version="1.0" ?><root>';
if(!isset($_GET['chat'])) 
{
$xml .='Your are not currently in a chat session.  <a href="">Enter a chat session here</a>';
$xml .= '<message id="0">';
$xml .= '<user>Admin</user>';
$xml .= '<text>Your are not currently in a chat session.  &lt;a href=""&gt;Enter a chat session here&lt;/a&gt;</text>';
$xml .= '<time>' . date('h:i') . '</time>';
$xml .= '</message>';
}
else
{
$last = (isset($_GET['last']) && $_GET['last'] != '') ? $_GET['last'] : 0;
$sql = "SELECT message_id, user_name, message, date_format(post_time, '%h:%i') as post_time" . 
    " FROM message WHERE chat_id = " . db_input($_GET['chat']) . " AND message_id > " . $last;
$message_query = db_query($sql);
//Loop through each message and create an XML message node for each.
while($message_array = db_fetch_array($message_query))
    {
    $xml .= '<message id="' . $message_array['message_id'] . '">';
    $xml .= '<user>' . htmlspecialchars($message_array['user_name']) . '</user>';
    $xml .= '<text>' . htmlspecialchars($message_array['message']) . '</text>';
    $xml .= '<time>' . $message_array['post_time'] . '</time>';
    $xml .= '</message>';
}
}
$xml .= '</root>';

