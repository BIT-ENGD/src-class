$server = Read-Host Enter server name...

if (!(test-connection -computername $server -quiet))
{ 
Write-Host $server is not pingable, does not exist, or timed out. Please try a different server.
}

else 
{
$command = 
{add-pssnapin WebAdministration

function get-iiswp([string]$name="*")
{

   $list = get-process w3wp -ea SilentlyContinue
   if ($error)
   {

Write-Host There are no IIS worker processes currently running. Error Message: $error

   }
        else
        {
            foreach($p in $list)
                { 
                $filter = "Handle='" + $p.Id + "'"
                $wmip = get-WmiObject Win32_Process -filter $filter 

                if($wmip.CommandLine -match "-ap `"(.+)`"")
                    {
                        $appName = $matches[1]
                        $p | add-member NoteProperty AppPoolName $appName
                    }
                }
    $list | where { $_.AppPoolName -like $name }
    }
}

get-iiswp | select-object -property *
}


invoke-command -computername $server -scriptblock $command | ConvertTo-HTML ID, AppPoolName, @{Label="CPU(s)";Expression={if ($_.CPU -ne $()) {$_.CPU.ToString("N")}}}, @{Label="Virtual Memory";Expression={[int]($_.VM/1MB)}}, @{Label="Physical Memory";Expression={[int]($_.WS/1024)}} | Out-file D:/test.html

}

<tr><tr><tr>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>HTML TABLE</title>
</head><body>
<h2>IIS Worker Process Diagnostic</h2>
<table>
<colgroup>
<col/>
<col/>
<col/>
<col/>
<col/>
</colgroup>
<tr><th>ID</th><th>AppPoolName</th><th>CPU(s)</th><th>Virtual Memory</th><th>Physical Memory</th></tr>
<tr><td>3820</td><td>AppPool1</td><td>4.92</td><td>355</td><td>74200</td></tr>
<tr><td>4108</td><td>AppPool2</td><td>0.23</td><td>106</td><td>21380</td></tr>
<tr><td>4940</td><td>AppPool3</td><td>0.20</td><td>590</td><td>39444</td></tr>
<tr><td>7244</td><td>AppPool4</td><td>0.33</td><td>596</td><td>42556</td></tr>
</table>
</body></html>

