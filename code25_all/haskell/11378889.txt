import qualified Database.SQLite as SQL
import Control.Applicative ((<$>))
import System.IO

buildSkypeMessages dbh = 
  (go <$> (SQL.execStatement dbh "select chatname,author,timestamp,body_xml from messages order by chatname, timestamp")) >>=
  writeIt
  where
    writeIt content = withFile "test.txt" WriteMode (\handle -> mapM_ (\(c:a:t:[]) -> hPutStrLn handle c) content)
    go (Left msg) = fail msg
    go (Right rows) = map f $ concat rows
      where
        f' (("chatname",SQL.Text chatname):
            ("author",SQL.Text author):
            ("timestamp",SQL.Int timestamp):
            r) = ([chatname, author], r)
        f xs = let (partEntry, (item:_)) = f' xs
               in case item of
                 ("body_xml",SQL.Text v) -> v:partEntry
                 ("body_xml",SQL.Null)   -> "":partEntry
        escape (_,SQL.Text v) = v
        escape (_,SQL.Null) = ""
        escape (_,SQL.Int v) = show v

