getData :: IO [Document]
getData = do
  pipe <- runIOE $ connect $ host "127.0.0.1"
  let run act = access pipe master "test" act
  result <- run (find (select [] "pcs") >>= rest)
  close pipe
  return $ either (const []) id result

mkSplice :: Document -> Splice AppHandler
mkSplice d = runChildrenWithText [dtp "id" d
                                 ,dtp "code" d
                                 ,dtp "name" d
                                 ]


dtp :: Text -> Document -> (Text,Text)
dtp tag d = (tag, T.pack $ show $ at tag d)

recSplice :: Splice AppHandler
recSplice = mapSplices mkSplice =<< liftIO getData

table :: Handler App App ()
table = heistLocal (bindSplice "rec" recSplice) $ render "table"

<table>
  <tbody>
    <rec>
      <tr><td><id/></td><td><code/></td><td><name/></td></tr>
    </rec>
  </tbody>
</table>

