foreach
data.table
foreach
> summary(results62)
       TM             PERMNO          MKTCAP                PM        
 Min.   :196201   Min.   :10006   Min.   :      41   Min.   :196112  
 1st Qu.:196205   1st Qu.:18382   1st Qu.:   11462   1st Qu.:196204  
 Median :196208   Median :24328   Median :   37367   Median :196207  
 Mean   :196207   Mean   :24349   Mean   :  215224   Mean   :196201  
 3rd Qu.:196210   3rd Qu.:29866   3rd Qu.:  132181   3rd Qu.:196209  
 Max.   :196212   Max.   :86239   Max.   :31349066   Max.   :196211  
                                                     NA's   :25     

> data1006 <- results62[PERMNO == 10006,]
> data10006
          TM PERMNO    MKTCAP     PM
 [1,] 196201  10006 104171.00 196112
 [2,] 196202  10006 104527.75 196201
 [3,] 196203  10006  97036.00 196202
 [4,] 196204  10006 102565.62 196203
 [5,] 196205  10006  85263.25 196204
 [6,] 196206  10006  84193.00 196205
 [7,] 196207  10006  98077.50 196206
 [8,] 196208  10006  97532.62 196207
 [9,] 196209  10006  92265.50 196208
[10,] 196210  10006  98804.00 196209
[11,] 196211  10006 105887.38 196210
[12,] 196212  10006 112062.62 196211

> data1006[,LAGMKTCAP := NA_real_]

> data1006[,LAGMKTCAP := data1006$MKTCAP[match(data1006$PM,data1006$TM)]]
          TM PERMNO    MKTCAP      PM LAGMKTCAP
 [1,] 196201  10006 104171.00  196112        NA
 [2,] 196202  10006 104527.75  196201 104171.00
 [3,] 196203  10006  97036.00  196202 104527.75
 [4,] 196204  10006 102565.62  196203  97036.00
 [5,] 196205  10006  85263.25  196204 102565.62 
 [6,] 196206  10006  84193.00  196205  85263.25 
 [7,] 196207  10006  98077.50  196206  84193.00
 [8,] 196208  10006  97532.62  196207  98077.50
 [9,] 196209  10006  92265.50  196208  97532.62
[10,] 196210  10006  98804.00  196209  92265.50
[11,] 196211  10006 105887.38  196210  98804.00
[12,] 196212  10006 112062.62  196211 105887.38

> results62[,LAGMKTCAP := results62$MKTCAP[match(results62$PM,results62$TM)],by=PERMNO]

[.data.table
:=
foreach
conumb <- unique(results62$PERMNO)

lag.mkt.cap <- function(results62){
results62$MKTCAP[match(results62$PM,results62$TM)]
}

lagmktcap <- foreach(i=1:length(conumb),.combine=c) %do% lag.mkt.cap(results62[PERMNO == conumb[i],])

foreach
data.table
dataexample <- data.table(TM = c(196201L, 196202L, 196203L, 196204L, 196201L, 196202L, 196203L, 196204L, 196201L, 196202L, 196203L, 196204L), 
PERMNO = c(10006L, 10006L, 10006L, 10006L, 10014L, 10014L, 10014L, 10014L, 10030L, 10030L, 10030L, 10030L), 
MKTCAP = c(104171, 104527.75, 97036, 102565.625, 13290.75, 14499, 13693.5, 12485.25, 81600, 83232, 81600, 82416), 
PM = c(196112L, 196201L, 196202L, 196203L, 196112L, 196201L, 196202L, 196203L, 196112L, 196201L, 196202L, 196203L))

