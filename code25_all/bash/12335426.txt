#!/bin/bash

# Pre-commit hook passing files through jslint and uglify

#ROOT_DIR=$(git rev-parse --show-toplevel)
JSLINT="/home/john/Projects/node/uglify/node_modules/.bin/jslint --indent 4 --white true -nomen"
UGLIFYJS="/home/john/Projects/node/uglify/node_modules/.bin/uglifyjs"
JS_TEMP_EDITOR="/home/john/Projects/node/test/generated/tmp/_combined_editor.js"
JS_COMBINED_EDITOR="/home/john/Projects/node/test/public/javascripts/editor.min.js"

# Where the editor files are located
BASE="/home/john/Projects/node/test/public/javascripts/editor/"
EDITOR=(
    "init.js"
    "utils.js"
    "validation.js"
    "main.js"
    "menu.js"
    "graph.js"
    "settings.js"
    "interview.js"
    "list.js"
    "thumbnail.js"
)

# go through each javascript file that has changed and run it rhough JSLINT
for file in $(git diff-index --name-only --diff-filter=ACM --cached HEAD -- | grep -P '\.((js)|(json))$'); do
    if  ! node $JSLINT $file 2>&1 | grep ${file}' is OK.' ; 
    then
        node $JSLINT $file
        exit 1
    fi  
done


# Erase old
> $JS_TEMP_EDITOR
> $JS_COMBINED_EDITOR

#run thru the EDITOR and cat the files into one
for editor_file in ${EDITOR[@]}; do
  cat "$BASE/$editor_file" >> $JS_TEMP_EDITOR
done


# check if  UGLIFYJS gives us an error
if node $UGLIFYJS $JS_TEMP_EDITOR 2>&1 | grep 'Error' ; 
then
    exit 1
else
        # *** THIS IS WHERE THE ERROR IS THROWN
    "node $UGLIFYJS -o $JS_COMBINED_EDITOR $JS_TEMP_EDITOR"
fi

exit 0

.git/hooks/pre-commit: line 55: node /home/john/Projects/node/uglify/node_modules/.bin/uglifyjs -o /home/john/Projects/node/test/public/javascripts/editor.min.js /home/john/Projects/node/test/generated/tmp/_combined_editor.js: No such file or directory

node /home/john/Projects/node/uglify/node_modules/.bin/uglifyjs -o /home/john/Projects/node/test/public/javascripts/editor.min.js /home/john/Projects/node/test/generated/tmp/_combined_editor.js

