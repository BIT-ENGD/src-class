#!/bin/sh

LOCAL=/var/local

TMP=/var/tmp

URL=http://um10.eset.com/eset_upd

USER=""
PASSWD=""

WGET="wget --user=$USER --password=$PASSWD -t 15 -T 15 -N -nH -nd -q"

UPDATEFILE="update.ver"

cd $LOCAL

CMD="$WGET $URL/$UPDATEFILE"
eval "$CMD" || exit 1;
if [ -n "`file $UPDATEFILE|grep -i rar`" ]; then
(
  cd $TMP
    rm -f $TMP/$UPDATEFILE
      unrar x $LOCAL/$UPDATEFILE ./
      )
      UPDATEFILE=$TMP/$UPDATEFILE
      URL=`echo $URL|sed -e s:/eset_upd::`
      fi
      TMPFILE=$TMP/nod32tmpfile
      grep file=/ $UPDATEFILE|tr -d \\r > $TMPFILE
      FILELIST=`cut -c 6- $TMPFILE`
      rm -f $TMPFILE
      echo "Downloading updates..."
      for FILE in $FILELIST; do
        CMD="$WGET \"$URL$FILE\""
          eval "$CMD"
          done
          cp $UPDATEFILE $LOCAL/update.ver
          perl -i -pe 's/\/download\/\S+\/(\S+\.nup)/\1/g' $LOCAL/update.ver
          echo "Done."

