key="target|platform|repo:revision"
hashname="hashmap"
declare -A $hashname

eval $hashname[$key]=0
echo $(eval $hashname[$key])

function print_hashmap()
{
    local hashname=$1
    for key in `eval echo \$\{\!$hashname[@]\}`; do
        local deref="$hashname[$key]"
        local value=${!deref}
        echo "key=${key} value=${value}"
    done
}
function create_permutations2()
{
    local hashname=$1   ; shift
    local builds=$1     ; shift
    local items=$1      ; shift
    local separators=$@

    echo "create_permutations(hashname=${hashname}, builds=${builds}, items=${items}, separators=${separators})"

    if [ NULL != "${builds}" ]; then
        for build in `echo $builds | tr ',' ' '`; do
            local target="${build%%:*}"
            local platforms="${build##*:}"
            for platform in `echo $platforms | tr '|' ' '`; do
                local key=
                local ref=
                if [ NULL != "${items}" ]; then
                    if [ NULL == "${separators}" ]; then separators=' '; fi
                    for separator in $separators; do
                        items=`echo $items | tr $separator ' '`
                    done
                    for item in $items; do
                        key="${target}|${platform}|${item}"
                        ref="$hashname[$key]"
                        declare "$ref"=0
                    done
                else
                    key="${target}|${platform}"
                    ref="$hashname[$key]"
                    declare "$ref"=0
                fi
            done
        done
    fi

    echo "created the following permutations:"
    print_hashmap $hashname
}
builds="k:r|s|w,l:r|s|w"
repos="c:master,m:master"
hashname="hashmap"
declare -A $hashname

create_permutations2 $hashname $builds $repos ","
print_hashmap $hashname

