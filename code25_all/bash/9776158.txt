#!/bin/bash

TYPE=$1

get_palaces(){
    for PALACE in $(ls -trI shared /home | sort); do
        if [ -d "/home/$PALACE/palace" ]; then
            echo $PALACE
        fi
    done
}
#  comm -12 file1 file2  Print only lines present in both file1 and file2.
# comm -3  file1 file2  Print lines in file1 not in file2, and vice vers
get_running_palaces(){
    echo "made it";
    PSFRONT_A=$(ps ax | grep '[p]sfront -p .* -r /home/.*/palace ' |  sed 's| *\([0-9]*\).*/home/\(.*\)/palace.*$|\2|' | uniq | sort)
    PSERVER_A=$(ps ax | grep '[p]server.* -f /home/.*/palace/psdata/pserver.conf ' | sed 's| *\([0-9]*\).*/home/\(.*\)/palace.*$|\2|' | sort)
    ERRORS=$(comm -3 <(echo "${PSERVER_A[*]}") <(echo "${PSFRONT_A[*]}"))
    if [ ! -z "$ERRORS" ]; then
        comm -3 <(echo "${PSERVER_A[*]}") <(echo "${ERRORS[*]}")
    else
        echo "$PSERVER_A"
    fi

}

case "$TYPE" in
online) 
    KNOWN_PALACES=$(get_palaces)
    ERROR_LESS=$(get_running_palaces)
    ONLINE=$(comm -12 <(echo "${KNOWN_PALACES[*]}") <(echo "${ERROR_LESS[*]}"))

    [ ! -z "$ONLINE" ] && echo "$ONLINE"
    ;;
offline)    
    KNOWN_PALACES=$(get_palaces | sort)
    ERROR_LESS=$(get_running_palaces)

    OFFLINE=$(comm -3 <(echo "${KNOWN_PALACES[*]}") <(echo "${ERROR_LESS[*]}"))

    [ ! -z "$OFFLINE" ] && echo "$OFFLINE"
    ;;
*)  
    get_palaces
    ;;
esac


exit 0;

