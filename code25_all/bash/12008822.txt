#!/bin/bash

#Set Time Machine Location
loc="8437"
echo "$loc \$loc done"

#Find Hostname
hostname=`hostname -s`
echo "$hostname \$hostname done"

#Find MAC Address
mac1=`ifconfig en0 | grep ether | tr -d ":" | awk {'print $2'}`
mac2=`ifconfig en0 | grep ether | awk {'print $2'}`
echo "$mac1 \$mac1 done"
echo "$mac2 \$mac2 done"

#Create a folder based on $loc
mkdir -p /Volumes/$loc
echo "mkdir $loc done"

#Mount Time Machine Share
mount_afp afp://timemachine:doctorwho@$loc.lbox.com/$loc /Volumes/$loc
echo "mounted share"

#Look for Time Machine Sparsebundle if it doesn't exist create it
if [[ ! -d /Volumes/$loc/"$hostname"_"$mac".sparsebundle ]]; then
    hdiutil create -size 300g -type SPARSEBUNDLE -fs HFS+J -volname "Time Machine Backups" /Volumes/$loc/"$hostname"_"$mac1"
fi
echo "ran hdiutil"

UUID=`system_profiler | grep 'Hardware UUID' | awk '{print $3}'`
echo "found $UUID \$UUID"

echo -n "Generating property list file with uuid $UUID and mac $mac2 ... "

echo '<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
<key>com.apple.backupd.HostUUID</key>
<string>'$UUID'</string>
</dict>
</plist>' > /Volumes/$loc/$hostname"_"$mac1".sparsebundle"/com.apple.TimeMachine.MachineID.plist
open .

echo "done!"

