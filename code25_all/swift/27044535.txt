class Foo<T, U: AnyObject> {

}

protocol Bar {
  typealias T: AnyObject // <- that appears to be the problem
  func foo() -> Foo<Self, T>
}

extension String: Bar {
  func foo() -> Foo<String, NSString> {
    return Foo<String, NSString>()
  }
}

