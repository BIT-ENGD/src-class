<div id="tracks">
    <%= render :partial => 'track', :collection => @release.tracks -%>
</div>

<%= add_track -%>

<div class="track">
    <fieldset>
    <legend>Track</legend>
    <p> 
        <% @track = track %>
    <%= error_messages_for :track -%>

        <% fields_for_track(track) do |track_form| -%>
        Track Name
    <br />
    <%= track_form.text_field :name -%>
    <%= link_to_function "remove", "$(this).up('.track').remove()" -%>
    <% track_links_id = "track_links_#{Time.now.to_i.to_s}" %>
    <div id="<%= track_links_id %>">
            <%= render :partial => 'track_link', :collection => @track.track_links -%>              
    </div>
    <%= add_track_link track_links_id -%>   
    <% end -%>
    </p>
</fieldset>
</div>

<div class="track_link">
    <% @track_link = track_link -%>
<% fields_for_track_link(track_link) do |track_link_form| -%>
    Track Link
    <br />
    <%= track_link_form.text_field :url -%>
    <%= select ("track_link_type", "id", @track_link_type.map {|type| [type.name, type.id]}) -%>        
        <%= link_to_function "remove", "$(this).up('.track_link').remove()" -%>     
<% end -%>
</div>

module ReleasesHelper
    def fields_for_track(track, &block)
        prefix = track.new_record? ? 'new' : 'existing'
        fields_for("release[#{prefix}_track_attributes][]", track, &block)
    end

    def fields_for_track_link(track_link, &block)
        prefix = track_link.new_record? ? 'new' : 'existing'
        fields_for("track[#{prefix}_track_link_attributes][]", track_link, &block)
    end

    def add_track
        track = Track.new
        track.track_links.build
        link_to_function 'Add Track' do |page| 
            page.insert_html :bottom, :tracks, :partial => 'track', :object => track
    end
end

    def add_track_link(name)
        link_to_function "Add Track Link" do |page|       
            page.insert_html :bottom, name, :partial => 'track_link', :object => TrackLink.new
    end
end
end

