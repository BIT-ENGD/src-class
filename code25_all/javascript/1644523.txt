var setupEditor = function() {

            if (/\?noundo/.test(doc.location.href)) {
                    wmd.nativeUndo = true;
            }

            if (!wmd.nativeUndo) {
                    undoMgr = new wmd.undoManager(function() {
                            previewRefreshCallback();
                            setUndoRedoButtonStates();
                    });
            }

            makeSpritedButtonRow();


            var keyEvent = "keydown";
            if (global.isOpera) {
                    keyEvent = "keypress";
            }

            util.addEvent(inputBox, keyEvent, function(key){

                    // Check to see if we have a button key and, if so execute the callback.
                    if (key.ctrlKey || key.metaKey) {

                            var keyCode = key.charCode || key.keyCode;
                            var keyCodeStr = String.fromCharCode(keyCode).toLowerCase();

                            switch(keyCodeStr) {
                                    case "b":
                                            doClick(document.getElementById("wmd-bold-button"));
                                            break;
                                    case "i":
                                            doClick(document.getElementById("wmd-italic-button"));

           (.............)

