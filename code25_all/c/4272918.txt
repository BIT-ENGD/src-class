#include <stdio.h>
#include <stdlib.h>
#include <string.h>



struct node_t {

 struct tuple_t *tuple; //Entrada na lista

 struct node_t *next; //o node seguinte da lista

};

struct tuple_t {
 long timestamp; /* instante de criacao do tuplo*/
 int n_fields; /* numero de campos deste tuplo */
 char **fields; /* array com campos do tuplo */
 /* 4 + 4 + 4  bytes?? */
};

char ** split_str(char [], char **, const char *);

struct node_t *node_create(void *node_data){

 struct node_t *node = NULL;
 node = (struct node_t *)malloc(sizeof(struct node_t));
 if(!node){
  printf("Erro ao criar um node!\n");
  return NULL;
 }

 node->tuple = (struct tuple_t *)malloc(sizeof(struct tuple_t));
 if(!node->tuple){printf("Erro ao criar o node->tuple\n"); free(node); return NULL;}

 node->tuple->fields = (char ** )malloc(strlen((char *) node_data) * sizeof(char *));
 if(!node->tuple->fields){ printf("Erro ao criar o node->tuple->node_fields\n"); free(node->tuple); free(node); return NULL; }

 char **array;
 const char *sep=" ";
 char *s = (char *)node_data;
 char arr[strlen(s)];
 int i = 0;
 while(arr[i++]=s[i]);

 array = split_str(arr,array, sep); 

 i = 0;
 while(array[i]){
  node->tuple->fields[i] = (char *)malloc((strlen(array[i])) * sizeof(char));
  if(!node->tuple->fields[i]){
   printf("Erro ao alocar memoria em node_create() para node->tuple->fields[i]\n");
   return NULL;
  }
  node->tuple->fields[i] = array[i];
//  printf("array[i]=%s\n",array[i]);
//  printf("node->tuple->fields[i]=%s\n",node->tuple->fields[i]);
  i++;

 }

 node->tuple->n_fields = i;
 node->tuple->timestamp = 0L;
 node->next = NULL;

 return node;
}

char** split_str(char writablestring[],char **array, const char *sep ){

 array = malloc(strlen(writablestring) + 1);

 if(! array){printf("Erro ao alocar memoria para o array em split\n"); return NULL;}

 char *token = strtok(writablestring, sep);

 int i=0;
 while(token != NULL)
 {
  array[i] = malloc(strlen(token)+1);
  if(!array[i])
   return NULL;
  array[i] = token;
  token = strtok(NULL, " ");
  i++;
 }

 return array;
}


int main(int argc, char** argv)
{

 void * n_data = "hello 123 ploc";

 struct node_t * node = node_create(n_data);
 printf("node->num_fields=%d\n", node->tuple->n_fields);
 int i=0;

 while( node->tuple->fields[i] ){
  printf("node->tuple->fields[%d]=%s\n",i,node->tuple->fields[i]);
  i++;
 }

 return 0;
}

