  snprintf((char*)buf+1,sizeof(buf)-1,"%.17g",val);

double x = ... some value ...
if (x == (double)((long long)x))
    use_the_fast_integer_function((long long)x);
else
    use_the_slow_snprintf(x);

