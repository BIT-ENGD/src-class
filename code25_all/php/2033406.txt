<?php
require_once('class.upload.php');
 if((isset($_POST['step']))&&($_POST['step']=='process')){
   $pictime = strtotime(date('Y-m-d H:i:s'));
   $pic = "picture";

   $id = $_POST['id'];

   $category = $_POST['category'];
   $username = $_POST['username'];
   $path = $_SERVER['DOCUMENT_ROOT'].$_POST['tempfile'];
   //connect to the server
   $conn = mysql_connect('localhost','root','');
   if(!$conn)
   {
   echo "Could not connect to the server";
   }

   //connect to the database
   $db = mysql_select_db("enzeon_db" , $conn);
   if(!$db)
   {
   echo "Could not connect to the database";
   }

   //query the database to get the imagepath and the thumbpath
   $query = "SELECT * FROM machine_db WHERE id = '$id' and m_category = '$category' and username = '$username'";

   $result = mysql_query($query) or die("Some error occured" . mysql_error());

   $num = mysql_num_rows($result);
   if($num == 1)
   {
   $row = mysql_fetch_array($result);
   $imagepath = $row['m_imagepath'];

   $imagethumb = $row['m_thumb_path'];

   }


   $handle = new Upload($_SERVER['DOCUMENT_ROOT'].$_POST['tempfile']);

   if ($handle->uploaded) {

    $handle->file_src_name_body      = $pic; // hard name
    $handle->file_new_name_body   = 'enzeon_'.$pictime;

    $handle->file_overwrite    = false;
    $handle->file_auto_rename    = false;
    $handle->image_resize            = true;
    $handle->file_src_pathname   = true; 
    $handle->image_x                 = 200; //size of final picture
    $handle->image_y                 = 200; //size of final picture

    $handle->jcrop                   = true;
    $handle->rect_w                  = $_POST['w']; 
    $handle->rect_h                  = $_POST['h']; 
    $handle->posX                    = $_POST['x']; 
    $handle->posY                    = $_POST['y'];
    $handle->jpeg_quality      = 100;
    $handle->Process($_SERVER['DOCUMENT_ROOT'].'/LoginSystem/upload_pic/');

    //thumb-50
    $handle->file_src_name_body      = $pic; // hard name
    $handle->file_new_name_body   = 'idrish_'.$pictime;
    $handle->file_overwrite    = false;
    $handle->file_auto_rename    = false;
    $handle->image_resize            = true;
    $handle->image_x                 = 100;
    $handle->image_y                 = 100; //size of picture

    $handle->jcrop                   = true;
    $handle->rect_w                  = $_POST['w']; 
    $handle->rect_h                  = $_POST['h']; 
    $handle->posX                    = $_POST['x']; 
    $handle->posY                    = $_POST['y'];
    $handle->jpeg_quality      = 100;
    $handle->Process($_SERVER['DOCUMENT_ROOT'].'/LoginSystem/upload_pic/');
     if($handle->processed)
     {
     echo "gimme some sunshine";
     }
     else
     {
     echo 'error' . $handle->error;
     }



    $handle->clean(); 

   } 
   else {

    echo "here" . $handle->error;
   }

 }
 echo "yes";
  //header("location:".$_SERVER["PHP_SELF"]);
?>

