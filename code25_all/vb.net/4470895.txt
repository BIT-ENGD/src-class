' Get the input document and total number of pages
Dim inputPdf As New iTextSharp.text.pdf.PdfReader(fileName)
Dim pageCount As Integer = inputPdf.NumberOfPages

' Load the input document 
Dim inputDoc As New iTextSharp.text.Document(inputPdf.GetPageSizeWithRotation(1))

' Set up the file stream for our output document
Dim outFileName As String = Path.ChangeExtension(fileName, "pdf")
Using fs As New FileStream(outFileName, FileMode.Create)
    ' Create the output writer
    Dim outputWriter As iTextSharp.text.pdf.PdfWriter = iTextSharp.text.pdf.PdfWriter.GetInstance(inputDoc, fs)
    inputDoc.Open()

    ' Copy pages from input to output document
    Dim cb As iTextSharp.text.pdf.PdfContentByte = outputWriter.DirectContent
    For index As Integer = 1 To pageCount
        inputDoc.SetPageSize(inputPdf.GetPageSizeWithRotation(index))
        inputDoc.NewPage()

        ' If this is our page to be rotated, perform the desired transform
        ' TODO - 90 degree rotations need to change the page orientation as well
        Dim page As iTextSharp.text.pdf.PdfImportedPage = outputWriter.GetImportedPage(inputPdf, index)
        If index = pageNum Then
            Select Case angle
                Case 90
                    cb.AddTemplate(page, 0, -1, 1, 0, 0, page.Height)
                Case 180
                    cb.AddTemplate(page, -1, 0, 0, -1, page.Width, page.Height)
                Case 270
                    cb.AddTemplate(page, 0, 1, -1, 0, page.Width, 0)
                Case Else
                    ' Should not be here, but don't do anything
                    cb.AddTemplate(page, 1, 0, 0, 1, 0, 0)
            End Select
        Else
            ' No rotation; add as is
            cb.AddTemplate(page, 1, 0, 0, 1, 0, 0)
        End If
    Next
    inputDoc.Close()
End Using

For index As Integer = 1 To pageCount
Dim pageSize As iTextSharp.text.Rectangle = inputPdf.GetPageSizeWithRotation(index)
If angle = 90 OrElse angle = 270 Then
    ' For 90-degree rotations, change the orientation of the page, too
    pageSize = New iTextSharp.text.Rectangle(pageSize.Height, pageSize.Width)
End If
inputDoc.SetPageSize(pageSize)
inputDoc.NewPage()

