<DllImport("winspool.Drv", EntryPoint:="DocumentPropertiesW", SetLastError:=True, _
    ExactSpelling:=True, CallingConvention:=CallingConvention.StdCall)> _
  Shared Function DocumentProperties(ByVal hwnd As IntPtr, ByVal hPrinter As IntPtr, _
      <MarshalAs(UnmanagedType.LPWStr)> ByVal pDeviceName As String, _
      ByVal pDevModeOutput As IntPtr, ByVal pDevModeInput As IntPtr, ByVal fMode As Integer) As Integer

   End Function

   <DllImport("kernel32.dll")> _
   Shared Function GlobalLock(ByVal hMem As IntPtr) As IntPtr

   End Function

   <DllImport("kernel32.dll")> _
   Shared Function GlobalUnlock(ByVal hMem As IntPtr) As Boolean

   End Function
   <DllImport("kernel32.dll")> _
   Shared Function GlobalFree(ByVal hMem As IntPtr) As Boolean

   End Function

   <DllImport("winspool.drv")> _
   Shared Function OpenPrinter(ByVal pPrinterName As String, ByRef hPrinter As IntPtr, ByVal pDefault As IntPtr) As Integer

   End Function

   <DllImport("winspool.drv")> _
   Private Shared Function ClosePrinter(ByVal phPrinter As IntPtr) As Integer

   End Function

DocumentProperties
pDevModeInput
ByRef
Public Sub OpenPrinterPropertiesDialog(ByVal iPrinterSettings As PrinterSettings)
      Dim hDevMode As IntPtr = iPrinterSettings.GetHdevmode()
      Dim pDevMode As IntPtr = GlobalLock(hDevMode)
      Dim sizeNeeded As Integer = DocumentProperties(mHandle, IntPtr.Zero, iPrinterSettings.PrinterName, pDevMode, pDevMode, 0)
      Dim devModeData As IntPtr = Marshal.AllocHGlobal(sizeNeeded)
      Dim fMode As Integer = 14
      Dim returnCode As Integer = DocumentProperties(mHandle, IntPtr.Zero, iPrinterSettings.PrinterName, devModeData, pDevMode, fMode)

      GlobalUnlock(hDevMode)
      iPrinterSettings.SetHdevmode(devModeData)
      iPrinterSettings.DefaultPageSettings.SetHdevmode(devModeData)

      GlobalFree(hDevMode)
      Marshal.FreeHGlobal(devModeData)
   End Sub

Public Sub OpenPrinterPropertiesDialog(ByVal iPrinterSettings As PrinterSettings)
      Dim printerName As String = iPrinterSettings.PrinterName
      Dim handle As IntPtr
      OpenPrinter(printerName, handle, IntPtr.Zero)

      Dim hDevMode As IntPtr = iPrinterSettings.GetHdevmode(iPrinterSettings.DefaultPageSettings)
      Dim pDevMode As IntPtr = GlobalLock(hDevMode)
      Dim sizeNeeded As Integer = DocumentProperties(mHandle, IntPtr.Zero, iPrinterSettings.PrinterName, pDevMode, pDevMode, 0)
      Dim devModeData As IntPtr = Marshal.AllocHGlobal(sizeNeeded)
      Dim fMode As Integer = 14
      Dim returnCode As Integer = DocumentProperties(mHandle, IntPtr.Zero, iPrinterSettings.PrinterName, devModeData, pDevMode, fMode)

      GlobalUnlock(hDevMode)
      iPrinterSettings.SetHdevmode(devModeData)
      iPrinterSettings.DefaultPageSettings.SetHdevmode(devModeData)
      returnCode = DocumentProperties(IntPtr.Zero, IntPtr.Zero, iPrinterSettings.PrinterName, devModeData, pDevMode, 2)

      ClosePrinter(handle)
      GlobalFree(hDevMode)
      Marshal.FreeHGlobal(devModeData)
   End Sub

