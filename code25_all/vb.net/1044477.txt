Imports System.Configuration

Public Class ConfigTest
    Inherits ConfigurationSection
<ConfigurationProperty("JunkProperty", IsRequired:=True)> _
Public Property JunkProperty() As String
    Get
        Return CStr(Me("JunkProperty"))
    End Get
    Set(ByVal value As String)
        ' *** Bug 1, exception ConfigurationErrorsException with message "The configuration is read only." thrown on the following line.
        Me("JunkProperty") = value
    End Set
End Property

Public Sub Save()
    Dim ConfigManager As Configuration = ConfigurationManager.OpenExeConfiguration(ConfigurationUserLevel.None)

    ' The add / remove is according to http://www.codeproject.com/KB/cs/SystemConfiguration.aspx
    ConfigManager.Sections.Remove("ConfigTest")
    ' *** Bug 2, exception InvalidOperationException thrown with message "Cannot add a ConfigurationSection that already belongs to the Configuration."
    ConfigManager.Sections.Add("ConfigTest", Me)
    ConfigManager.Save(ConfigurationSaveMode.Full, True)

End Sub

Public Shared Sub Main()
    Dim AppConfig As ConfigTest = TryCast(ConfigurationManager.GetSection("ConfigTest"), ConfigTest)

    AppConfig.JunkProperty = "Some test data"
    AppConfig.Save()

End Sub

' App.Config should be:
'    <?xml version="1.0" encoding="utf-8" ?>
    '<configuration>
    '  <configSections>
    '    <section name="ConfigTest" type="ConsoleApp.ConfigTest, ConsoleApp" />
    '  </configSections>
    '  <ConfigTest JunkProperty="" />
    '</configuration>

End Class

