Dim t as Thread = New Thread(New ThreadStart(AddressOf EmailLetters))
t.Start()

Dim fs = Server.CreateObject("Scripting.FileSystemObject")
fs.DeleteFolder(Server.MapPath(".") + "\tmpEmailFiles")

<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<%@ Import Namespace="System.Threading" %>
<%@ Page Language="VB" Debug="true" %>
<%@ Implements Interface="System.Web.UI.IPostBackEventHandler" %>

<SCRIPT language="vb" runat="server">

  Sub Page_Load(Src As Object, e As EventArgs)

  End Sub

  Public Sub Test(src as Object, e as EventArgs)

    Dim t as Thread = New Thread(New ThreadStart(AddressOf TestWorker))
    t.Start()

    Session("BackgroundThread") = t

  End Sub

  Public Sub TestWorker()

    ' 30 Second Delay
    System.Threading.Thread.Sleep(30000)

    Dim root as String = Server.MapPath(".")
    Dim fs = Server.CreateObject("Scripting.FileSystemObject")
    If Not fs.FolderExists(root + "\Test") Then fs.CreateFolder(root + "\Test")
    fs.DeleteFolder(root + "\Test")

    ErrMsg.Text = "Start: " + DateTime.Now.ToString()

  End Sub

  Public Sub RaisePostBackEvent(ByVal eventArgument As String) _
    Implements IPostBackEventHandler.RaisePostBackEvent

    If Session("BackgroundThread") is Nothing Then
      Exit Sub
    End If

    Dim t as Thread = CType(Session("BackgroundThread"), Thread)
    If t.ThreadState = ThreadState.Stopped Then
      ErrMsg.Text = "Done: " + DateTime.Now.ToString() 
      Session("BackgroundThread") = Nothing
    Else
      ErrMsg.Text = "Processing: " + DateTime.Now.ToString() + " - " + t.ThreadState.ToString()
    End If

  End Sub

</SCRIPT>

<HTML>
<HEAD>
  <SCRIPT language="javascript">
  //<!--

  function onLoad()
  {
    if(<%= IIF(Session("BackgroundThread") is Nothing, "false", "true") %>)
    {
      toggleLoading();
      setTimeout("<%= Page.ClientScript.GetPostBackEventReference(Me, "") %>", 10000);
    }
  }

  function toggleLoading(){
    document.getElementById('imgLoading').style.display = 'block';
    setTimeout("document.images['imgLoading'].src='images/loading.gif'", 100); 
  }

  // -->
  </SCRIPT>
</HEAD>

<BODY OnLoad="onLoad();">
<FORM runat="server">

  <ASP:Button runat="server" Text="Test" OnClick="Test" onClientClick="javascript: toggleLoading();" />
  <ASP:Label runat="server" Id="ErrMsg" />
  <IMG id="imgLoading" src="images/loading.gif" style="display: none;" />

</FORM>
</BODY>
</HTML>

