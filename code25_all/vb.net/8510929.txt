Public Class FormMain

    Shared dataAdapter As OleDbDataAdapter
    Shared logTable As New DataTable("log")
    Shared commandBuilder As OleDbCommandBuilder
    Shared queryString As String = "SELECT * FROM log"
    Shared bindingSource As New BindingSource

    Private Sub FormServerBridge_Load(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles MyBase.Load
        Try
            ConfigureDataSet()
            ConfigureBindingSource()
            ConfigureDataView()
        Catch ex As Exception
            ' FIXME: Helpful for debugging purposes but awful for the end-user.
            MessageBox.Show(ex.Message)
        End Try
    End Sub

    Private Sub ConfigureDataSet()
        dataAdapter = New OleDbDataAdapter(queryString, _Config.ConnectionString)
        commandBuilder = New OleDbCommandBuilder(dataAdapter)
        commandBuilder.GetUpdateCommand()

        dataAdapter.Fill(logTable)

        With logTable
            .Locale = System.Globalization.CultureInfo.InvariantCulture
            .PrimaryKey = New DataColumn() {logTable.Columns("ID")}
        End With
    End Sub

    Private Sub ConfigureBindingSource()
        With bindingSource
            .DataSource = logTable
        End With
    End Sub

    Private Sub ConfigureDataView()
        With DataGridView
            .DataSource = bindingSource
        End With
    End Sub

    Private Sub DataGridView_Click(ByVal sender As Object, ByVal e As System.EventArgs) Handles DataGridView.Click
        UpdateUI()
    End Sub

    Sub UpdateUI()
        dataAdapter.Fill(logTable)
    End Sub

    Private Sub DataGridView_DataBindingComplete(ByVal sender As Object, ByVal e As DataGridViewBindingCompleteEventArgs) Handles DataGridView.DataBindingComplete

        ' FIXME: This code gets run as many times as there are rows after dataAdapter.Fill!

        With DataGridView
            .Columns("ID").Visible = False

            .Columns(1).HeaderText = "Timestamp"

            .Columns(1).AutoSizeMode = DataGridViewAutoSizeColumnMode.AllCells
            .Columns(2).AutoSizeMode = DataGridViewAutoSizeColumnMode.AllCells
            .Columns(3).AutoSizeMode = DataGridViewAutoSizeColumnMode.Fill
        End With

    End Sub
End Class

