 BOOL isDir;
    NSString *file;
 NSString *docsDir = [self path];
 NSFileManager *manager = [NSFileManager defaultManager];
 NSDirectoryEnumerator *dirEnum = [manager enumeratorAtPath: docsDir];
 NSDictionary *fattrs;
        //(only showing important declarations above)

while (file = [dirEnum nextObject]) {
    //If user clicked the Abort Button, get out of the loop
    if (abortFlag)
        break;

    if ([excludeSubdirectories state] == NSOnState) {
        [dirEnum skipDescendents];
    }

    if ([manager fileExistsAtPath:[docsDir stringByAppendingPathComponent:file]
                      isDirectory:&isDir] && isDir) {
       ++dirCount;
       if ([excludeSubdirectories state] == NSOnState) {
           continue;
       }
    }
}
            //... Do a bunch of other stuff, etc., etc. ...

