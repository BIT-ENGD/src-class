sub build_results_hash {
    my %results;
    my $search = $_[0];
    my $json = $_[1];
    my $json_passed = $_[2];

    my $dbh = db_connect(-db=>'ghgs');

    my $db_search = html_db_input($search,$dbh);
    %results = db_hoh(-query=>"SELECT listing_id,MATCH(search) AGAINST($db_search) as relevance FROM search WHERE MATCH(search) AGAINST($db_search) LIMIT 1000",-key=>"listing_id",-dbh=>$dbh);

    if(($json_passed == 1) and ($json ne '[]'))
    {
        narrow_results_hash(\%results,$search,$dbh,$json);
    }

    db_x($dbh);

    return \%results;
}

sub db_hoh {
    # ...
    return %hoh;
}

db_hoh
narrow_results_hash
%results
if
sub narrow_results_hash
{
    use JSON::XS;
    my $params = shift;
    my %results = %$params;
    # ...
    print join(',',keys %results), "\n";
    # ...
}

if
narrow_results_hash
build_results_hash
if
