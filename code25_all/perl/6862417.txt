success
error
initializing
abort
expired
abort
-e $filepath
my $cgi = CGI->new(\&hook, \%data, 0);

sub hook { 
    my $status = GetStatus();

    if(-e $$data{filepath} and $status eq "initializing"){
        # send JSON back to browser
        # insert your amazing snippet here
        ... 
    }

    if($status eq "success"){
        # continue writing file to disk
        # update db
        ... 
    }

    if($status eq "abort"){
        # cancel the upload
        # insert your amazing snippet here
        ... 
    }

} 

<iframe id="upload_target" onload="uploadDone();"></iframe>

$('#upload_form').submit(function(data){
    window.setInterval('doProgress()', 250);
});

function doProgress() {
    $.ajax({
        ...
        success: function(data){
            json = $.parseJSON(data);
            if(json.status != null){
                // json.message contains the percentage number
                $("#progressbar").reportprogress(json.message);
            }
        }
    });
}

function uploadDone() { 
    var ret = $('#upload_target').contents().find('body').text();
    var json = jQuery.parseJSON(ret);

    if(json.status != null){
        $.modal.close();
        show_message(json);
    }
}

xhr.abort();
