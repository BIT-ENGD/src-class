<div id="page">
    <div id="header"><h1>header</h1></div>

    <div id="body">
        <h1>content top -> when scrolling up the box should STOP here (at the line right above this text)</h1>

        <div id="floating-box"></div>
        <span style="position: absolute; bottom: 0; ">content bottom -> when scrolling down the box should STOP here (at the line right below this text)</span>

    </div>
    <div id="footer"><h1>footer</h1></div>
    <div id="debug"></div>
</div>

#floating-box{
    width:90px;
    height:200px;
    border:1px solid red;
    background-color:#BBBBBB;
    position:absolute;
    bottom: 0;
    z-index:1;
}

#page{
    width:800px;
    margin:0 auto;
}
#header{
    border:1px solid blue;
    height:1010px;
    margin:8px;
}
#body{
    border:1px solid blue;
    height:540px;
    margin:8px;
    position: relative;
}
#footer{
    border:1px solid blue;
    height:1500px;
    margin:8px;
}
h1,h2{
    padding:16px;
}

#debug {
    position: fixed;
    bottom: 0;
    right: 0;
    height: 100px;
    width: 100px;
    color: red;
}

var windowHeight = $(window).height();

var $box = $('#floating-box');
var $parent = $('#body');
var parentAbsoluteTop = $parent.offset().top;
var parentAbsoluteBottom = parentAbsoluteTop + $parent.height();
var topStop = parentAbsoluteTop + $box.height();

$(window).scroll(function(event) {
    var windowBottom = $(window).scrollTop() + windowHeight;

    if (windowBottom < topStop)
        $box.css({
            position: 'absolute',
            top: '0px',
            bottom: 'auto'
        });
    else if (windowBottom >= topStop && windowBottom <= parentAbsoluteBottom)
        $box.css({
            position: 'fixed',
            top: 'auto',
            bottom: '0px'
        });
    else
        $box.css({
            position: 'absolute',
            top: 'auto',
            bottom: '0px'
        });
});

