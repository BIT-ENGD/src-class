return (TId) entityMeta.GetIdentifier(entity);

return (TId) entityMeta.GetIdentifier(entity, EntityMode.Map);

public TId GetId<TId>(TEntity entity)
{
    ISessionFactory sessionFactory = NHibernateSessionManager.Instance.GetSessionFactoryFor(assembly);

    if (sessionFactory == null)
    {
        sessionFactory = NHibernateSessionManager.Instance.GetSessionFactoryFor(GetNHibernateConfig());
    }

    IClassMetadata entityMeta = sessionFactory.GetClassMetadata(typeof(TEntity));

    return (TId) entityMeta.GetIdentifier(entity, EntityMode.Map);
}

